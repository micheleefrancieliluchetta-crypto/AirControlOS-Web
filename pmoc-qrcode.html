<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>QR Codes PMOC - AirControl OS</title>

  <link rel="stylesheet" href="css/style.css">

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#1e90ff" />

  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <!-- Lib de QRCode (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
          integrity="sha512-MQzvM2Nf1pGg0sM4e2Y2fEPi9P4kWvHgHqvHTtu1TtRC6N0fHqD6YQX7qYJxQHpoSuxA0Zg4qtL3qnV8Y+Hfg=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    .qrcode-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .btn-imprimir {
      padding: 8px 14px;
      border-radius: 6px;
      border: none;
      background: #1e90ff;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
    }

    .qr-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }

    .qr-card {
      background: #fff;
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      text-align: center;
    }

    .qr-card h3 {
      margin: 4px 0 6px;
      font-size: 15px;
    }

    .qr-card p {
      margin: 0;
      font-size: 12px;
    }

    .qr-box {
      margin: 10px auto 4px;
      min-height: 128px; /* garante espaÃ§o pro QR aparecer */
    }

    .qr-url {
      font-size: 10px;
      word-break: break-all;
      color: #555;
      margin-top: 4px;
    }

    @media print {
      .topbar,
      .sidebar,
      .qrcode-header {
        display: none !important;
      }
      body {
        background: #fff;
      }
      .qr-card {
        box-shadow: none;
        border: 1px solid #ddd;
      }
    }
  </style>
</head>
<body>
  <!-- TOPO COM VOLTAR -->
  <header class="topbar">
    <button onclick="window.location.href='dashboard.html'" class="btn-voltar">â†</button>
    <h1>QR Codes PMOC</h1>
    <button onclick="logout()">Sair</button>
  </header>

  <!-- MENU LATERAL -->
  <nav class="sidebar">
    <ul>
      <li><a href="dashboard.html">ğŸ  Dashboard</a></li>
      <li><a href="ordem-servico.html">ğŸ“ Ordem de ServiÃ§o - ManutenÃ§Ã£o Corretiva</a></li>
      <li><a href="calendario.html">ğŸ“… Agenda</a></li>
      <li><a href="local.html">ğŸ“ Locais / Unidades</a></li>
      <li><a href="tecnico.html">ğŸ§‘â€ğŸ”§ TÃ©cnicos</a></li>
      <li><a href="usuarios.html">ğŸ‘¤ UsuÃ¡rios - Acesso ao Sistema</a></li>
      <li><a href="aparelhos-por-unidade.html">ğŸ¥ Aparelhos por unidade</a></li>
      <li><a href="pmoc.html">âœ… Checklist PMOC</a></li>
      <li><a href="pmoc-historico.html">ğŸ“‚ HistÃ³rico PMOC</a></li>
      <li><a href="pmoc-menu.html">ğŸ“Œ PMOC por cidade / unidade</a></li>
      <!-- IMPORTANTE: MESMO NOME DO ARQUIVO -->
      <li><a href="pmoc-qrcode.html">ğŸ”³ QR Codes PMOC</a></li>
    </ul>
  </nav>

  <!-- CONTEÃšDO -->
  <main class="main-content">
    <div class="qrcode-header">
      <div>
        <h2>Gerar QR Codes para os aparelhos</h2>
        <p style="font-size:13px; color:#555;">
          Cada QR abre o histÃ³rico do aparelho em
          <code>pmoc-historico.html?aparelhoId=...</code>
        </p>
      </div>
      <button class="btn-imprimir" onclick="window.print()">Imprimir pÃ¡gina</button>
    </div>

    <section id="listaQRCodes" class="qr-grid"></section>

    <p id="msgQRCodes" style="font-size:13px; color:#666; margin-top:16px;"></p>
  </main>

  <script src="js/script.js"></script>

  <script>
    // ============================
    // 1) Fallback DEMO (caso API caia)
    // ============================
    const aparelhosDemo = [
      {
        id: 10,
        unidade: "Hospital Vicentino",
        local: "3Âº andar - Enfermaria",
        descricao: "Split 18.000 BTU"
      },
      {
        id: 11,
        unidade: "Hospital Vicentino",
        local: "Sala de Espera",
        descricao: "Split 24.000 BTU"
      },
      {
        id: 2,
        unidade: "Hospital Vicentino",
        local: "Posto de Enfermagem",
        descricao: "Split 9.000 BTU"
      }
    ];

    const msgQRCodes = document.getElementById("msgQRCodes");

    // ============================
    // 2) Montar QRCodes na tela
    // ============================
    function montarQRCodes(listaAparelhos) {
      const container = document.getElementById("listaQRCodes");
      container.innerHTML = "";

      if (!listaAparelhos || !listaAparelhos.length) {
        msgQRCodes.textContent = "Nenhum aparelho encontrado para gerar QR Codes.";
        return;
      }

      const baseUrl = `${window.location.origin}/pmoc-historico.html`;

      listaAparelhos.forEach(ap => {
        const urlHistorico = `${baseUrl}?aparelhoId=${ap.id}`;

        const card = document.createElement("article");
        card.className = "qr-card";

        const titulo = document.createElement("h3");
        titulo.textContent = `Aparelho #${ap.id} - ${ap.descricao || "Ar condicionado"}`;

        const info = document.createElement("p");
        info.textContent = `Unidade: ${ap.unidade} â€¢ Local: ${ap.local || "-"}`;

        const qrBox = document.createElement("div");
        qrBox.className = "qr-box";

        const urlTexto = document.createElement("div");
        urlTexto.className = "qr-url";
        urlTexto.textContent = urlHistorico;

        card.appendChild(titulo);
        card.appendChild(info);
        card.appendChild(qrBox);
        card.appendChild(urlTexto);

        container.appendChild(card);

        // Se por algum motivo a lib nÃ£o carregar, mostra mensagem no lugar
        if (typeof QRCode === "undefined") {
          qrBox.textContent = "Erro ao carregar biblioteca de QR Code.";
        } else {
          new QRCode(qrBox, {
            text: urlHistorico,
            width: 128,
            height: 128
          });
        }
      });

      msgQRCodes.textContent = `${listaAparelhos.length} QR Code(s) gerado(s).`;
    }

    // ============================
    // 3) Carregar aparelhos do banco
    //    usando a mesma API de
    //    aparelhos-por-unidade.html
    // ============================
    const API_APARELHOS = "https://aircontrolos-api.onrender.com/api/aparelhos-hdv";

    async function carregarAparelhosDoBanco() {
      try {
        const resp = await fetch(API_APARELHOS);
        if (!resp.ok) throw new Error("Resposta nÃ£o OK: " + resp.status);

        const dados = await resp.json();

        // Mapeia por unidadeExterna (HDV) => 1 QR por mÃ¡quina
        const mapa = new Map();

        dados.forEach(item => {
          const hdv = item.unidadeExterna; // mesmo campo usado na tabela
          if (!hdv || hdv === "-" ) return; // sem ID, sem QR

          if (!mapa.has(hdv)) {
            const descricao =
              `${item.marca || ""} ${item.btu ? item.btu + " BTU" : ""}`.trim() || "Ar condicionado";

            mapa.set(hdv, {
              id: hdv, // esse Ã© o aparelhoId que vai para pmoc-historico.html
              unidade: "Hospital Vicentino", // hoje sÃ³ tem essa, depois dÃ¡ pra puxar da API se tiver
              local: item.local || "-",
              descricao
            });
          }
        });

        const lista = Array.from(mapa.values()).sort((a, b) => a.id - b.id);

        if (!lista.length) {
          console.warn("API retornou, mas nÃ£o foi possÃ­vel montar lista. Usando demo.");
          montarQRCodes(aparelhosDemo);
          return;
        }

        montarQRCodes(lista);
      } catch (e) {
        console.error("Erro ao carregar aparelhos do banco, usando lista demo:", e);
        msgQRCodes.textContent = "Erro ao carregar aparelhos da API. Mostrando exemplo.";
        montarQRCodes(aparelhosDemo);
      }
    }

    document.addEventListener("DOMContentLoaded", carregarAparelhosDoBanco);
  </script>

  <!-- SW -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js', { scope: './' })
        .catch(console.error);
    }
  </script>
</body>
</html>
