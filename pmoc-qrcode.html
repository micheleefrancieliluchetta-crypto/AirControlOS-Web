<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>QR Codes PMOC - Sistemas Maxi</title>

  <!-- Seu CSS principal -->
  <link rel="stylesheet" href="css/style.css">

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#1e90ff" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <!-- Lib de QRCode (SEM integrity pra n√£o bloquear) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    .qrcode-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .btn-imprimir {
      padding: 8px 14px;
      border-radius: 6px;
      border: none;
      background: #1e90ff;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
    }

    .qr-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }

    .qr-card {
      background: #fff;
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      text-align: center;
    }

    .qr-card h3 {
      margin: 4px 0 6px;
      font-size: 15px;
    }

    .qr-card p {
      margin: 0;
      font-size: 12px;
    }

    .qr-box {
      margin: 10px auto 4px;
    }

    .qr-url {
      font-size: 10px;
      word-break: break-all;
      color: #555;
      margin-top: 4px;
    }

    @media print {
      .topbar,
      .sidebar,
      .qrcode-header {
        display: none !important;
      }
      body {
        background: #fff;
      }
      .qr-card {
        box-shadow: none;
        border: 1px solid #ddd;
      }
    }
  </style>
</head>
<body>
  <!-- TOPO COM VOLTAR -->
  <header class="topbar">
    <button onclick="window.location.href='dashboard.html'" class="btn-voltar">‚Üê</button>
    <h1>QR Codes PMOC</h1>
    <button onclick="logout()">Sair</button>
  </header>

  <!-- MENU LATERAL -->
  <nav class="sidebar">
    <ul>
      <li><a href="dashboard.html">üè† Dashboard</a></li>
      <li><a href="ordem-servico.html">üìù Ordem de Servi√ßo - Manuten√ß√£o Corretiva</a></li>
      <li><a href="calendario.html">üìÖ Agenda</a></li>
      <li><a href="local.html">üìç Locais / Unidades</a></li>
      <li><a href="tecnico.html">üßë‚Äçüîß T√©cnicos</a></li>
      <li><a href="usuarios.html">üë§ Usu√°rios - Acesso ao Sistema</a></li>
      <li><a href="aparelhos-por-unidade.html">üè• Aparelhos por unidade</a></li>
      <li><a href="pmoc.html">‚úÖ Checklist PMOC</a></li>
      <li><a href="pmoc-historico.html">üìÇ Hist√≥rico PMOC</a></li>
      <li><a href="pmoc-menu.html">üìå PMOC por cidade / unidade</a></li>
      <li><a href="pmoc-qrcode.html">üî≥ QR Codes PMOC</a></li>
      <li><a href="pecas.html">üõ†Ô∏è Pe√ßas / Cat√°logo</a></li>
    </ul>
  </nav>

  <!-- CONTE√öDO CENTRAL -->
  <main class="main-content">
    <div class="qrcode-header">
      <div>
        <h2>Gerar QR Codes para os aparelhos</h2>
        <p style="font-size:13px; color:#555;">
          Cada QR abre o hist√≥rico do aparelho em
          <code>pmoc-historico.html?aparelhoId=...</code>
        </p>
        <p id="infoQuantidade" style="font-size:13px; color:#333;">
          0 QR Code(s) gerado(s).
        </p>
      </div>
      <button class="btn-imprimir" onclick="window.print()">Imprimir p√°gina</button>
    </div>

    <section id="listaQRCodes" class="qr-grid"></section>
  </main>

  <!-- Script principal (menu, logout, etc.) -->
  <script src="js/script.js"></script>

  <script>
    const API_APARELHOS_URL = "https://aircontrolos-api.onrender.com/api/aparelhos-hdv";

    async function carregarAparelhosDoBanco() {
      const container = document.getElementById("listaQRCodes");
      const infoQuantidade = document.getElementById("infoQuantidade");

      container.innerHTML = "";
      infoQuantidade.textContent = "Carregando aparelhos...";

      try {
        const resp = await fetch(API_APARELHOS_URL);
        if (!resp.ok) {
          throw new Error("Erro ao buscar aparelhos do backend.");
        }

        const dados = await resp.json();
        const aparelhos = Array.isArray(dados) ? dados : [];

        if (!aparelhos.length) {
          infoQuantidade.textContent = "Nenhum aparelho encontrado na base.";
          return;
        }

        const baseUrlHistorico = `${window.location.origin}/pmoc-historico.html`;
        let totalGerados = 0;

        aparelhos.forEach(ap => {
          // üëâ Usa a UNIDADE EXTERNA como ID HDV do aparelho
          const aparelhoId = ap.unidadeExterna;

          const desc =
            ap.modelo ||
            ap.descricao ||
            (ap.marca && ap.btu ? `${ap.marca} ${ap.btu} BTU` : "Ar condicionado");

          const unidadeExt = ap.unidadeExterna ?? "-";
          const local = ap.local ?? "-";

          const card = document.createElement("article");
          card.className = "qr-card";

          const titulo = document.createElement("h3");
          titulo.textContent = `Aparelho #${aparelhoId ?? "?"} - ${desc}`;

          const info = document.createElement("p");
          info.textContent = `Unidade externa: ${unidadeExt} ‚Ä¢ Local: ${local}`;

          const qrBox = document.createElement("div");
          qrBox.className = "qr-box";

          const urlTexto = document.createElement("div");
          urlTexto.className = "qr-url";

          card.appendChild(titulo);
          card.appendChild(info);
          card.appendChild(qrBox);
          card.appendChild(urlTexto);

          container.appendChild(card);

          // S√≥ gera QR se tiver unidadeExterna v√°lida (n√∫mero, n√£o "-")
          if (
            aparelhoId !== null &&
            aparelhoId !== undefined &&
            aparelhoId !== "-" &&
            aparelhoId !== ""
          ) {
            const urlHistorico =
              `${baseUrlHistorico}?aparelhoId=${encodeURIComponent(aparelhoId)}`;

            urlTexto.textContent = urlHistorico;

            if (typeof QRCode !== "undefined") {
              new QRCode(qrBox, {
                text: urlHistorico,
                width: 128,
                height: 128
              });
              totalGerados++;
            } else {
              qrBox.textContent = "Erro ao carregar biblioteca de QR Code.";
            }
          } else {
            qrBox.textContent = "N√£o foi poss√≠vel gerar QR (sem ID HDV).";
            urlTexto.textContent = "";
          }
        });

        infoQuantidade.textContent = `${totalGerados} QR Code(s) gerado(s).`;
      } catch (e) {
        console.error(e);
        infoQuantidade.textContent = "Erro ao carregar aparelhos para gerar QR Codes.";
      }
    }

    document.addEventListener("DOMContentLoaded", carregarAparelhosDoBanco);
  </script>

  <!-- Service Worker PWA -->
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker
        .register("./service-worker.js", { scope: "./" })
        .catch(console.error);
    }
  </script>
</body>
</html>


