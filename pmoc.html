<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checklist PMOC</title>

  <style>
    body {
      margin: 0;
      background: #f3f4f6;
      font-family: Arial, sans-serif;
    }

    .topo {
      background: #007bff;
      color: white;
      padding: 16px;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .voltar {
      background: rgba(255,255,255,0.25);
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      color: white;
      font-size: 14px;
    }

    .container {
      max-width: 900px;
      margin: auto;
      padding: 16px;
    }

    .card {
      background: white;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    h2 {
      margin-top: 0;
      font-size: 18px;
    }

    .grid {
      display: grid;
      gap: 12px;
    }

    .campo label {
      font-size: 13px;
      color: #555;
    }

    .campo input {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .item {
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }

    .linha-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .nome-item {
      font-size: 15px;
      font-weight: 600;
    }

    /* SWITCH */
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #37d67a; /* verde padrão */
      transition: 0.2s;
      border-radius: 999px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: 0.2s;
      border-radius: 50%;
    }

    /* vermelho quando "problema" */
    .switch input.problem + .slider {
      background-color: #ff4d4d !important;
    }

    .switch input.problem + .slider:before {
      transform: translateX(20px);
    }

    textarea {
      width: 100%;
      margin-top: 8px;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      resize: vertical;
    }

    .btn-obs {
      width: 100%;
      padding: 10px;
      background: #e7f1ff;
      border: 1px solid #70a9ff;
      border-radius: 8px;
      color: #0056c7;
      cursor: pointer;
      margin-top: 10px;
    }

    #obsTecnicaBox {
      margin-top: 10px;
      display: none;
    }

    .btn-salvar {
      width: 100%;
      background: #007bff;
      border: none;
      padding: 14px;
      color: white;
      font-size: 16px;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 18px;
    }

    .pops-links {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .btn-pop {
      display: inline-block;
      padding: 8px 12px;
      border-radius: 8px;
      background: #f1f5f9;
      border: 1px solid #cbd5f5;
      font-size: 13px;
      text-decoration: none;
      color: #0056c7;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-pop:hover {
      background: #e2ecff;
    }
  </style>
</head>

<body>
  <div class="topo">
    <button class="voltar" onclick="window.location.href='dashboard.html'">←</button>
    Checklist PMOC
  </div>

  <!-- FORM PMOC -->
  <form id="formPmoc">
    <div class="container">

      <!-- Dados do aparelho -->
      <div class="card">
        <h2>Dados do aparelho</h2>

        <div class="grid">
          <div class="campo">
            <label>ID do aparelho (HDV)</label>
            <input id="aparelhoHdvId" type="number" placeholder="Ex.: 2, 3, 10, 90" />
          </div>

          <div class="campo">
            <label>Patrimônio</label>
            <input id="patrimonio" type="text">
          </div>

          <div class="campo">
            <label>Unidade</label>
            <input id="unidade" type="text">
          </div>

          <div class="campo">
            <label>Local</label>
            <input id="local" type="text">
          </div>

          <div class="campo">
            <label>Marca</label>
            <input id="marca" type="text">
          </div>

          <div class="campo">
            <label>BTUs</label>
            <input id="btu" type="text">
          </div>

          <div class="campo">
            <label>Modelo</label>
            <input id="modelo" type="text">
          </div>

          <div class="campo">
            <label>Data</label>
            <input id="data" type="date">
          </div>
        </div>
      </div>

         <div class="campo">
            <label>Nome do técnico</label>
            <input id="nomeTecnicoInput" type="text" placeholder="Digite seu nome">
      </div>

      <!-- POPs -->
      <div class="card" id="popsSection">
        <h2>POPs / Orientações gerais</h2>
        <p style="font-size:13px; margin-top:4px;">
          Abaixo estão os POPs gerais de higienização, instalação e testes.
          Eles abrem em outra aba para consulta durante o checklist.
        </p>

        <div class="pops-links">
          <a href="docs/POP_Higienizacao_Ar_Condicionado_Split.pdf" target="_blank" class="btn-pop">
            POP – Higienização Split
          </a>

          <a href="docs/POP_Instalacao_Ar_Condicionado_Split.pdf" target="_blank" class="btn-pop">
            POP – Instalação Split
          </a>

          <a href="docs/POP_Teste_e_Troca_Capacitor.pdf" target="_blank" class="btn-pop">
            POP – Teste e troca de capacitor
          </a>

          <a href="docs/Fichas_de_Monitoramento.pdf" target="_blank" class="btn-pop">
            Fichas de monitoramento
          </a>

          <a href="docs/Teste_Compressor_e_Motoventilador.pdf" target="_blank" class="btn-pop">
            POP – Teste de compressor e moto-ventilador
          </a>
        </div>
      </div>

      <!-- CHECKLIST -->
      <div class="card">
        <h2>Checklist</h2>

        <div class="item">
          <div class="linha-item">
            <span class="nome-item">Funcionamento geral</span>
            <label class="switch">
              <input type="checkbox" class="chk-item" data-nome="Funcionamento geral" onclick="toggleColor(this)">
              <span class="slider"></span>
            </label>
          </div>
          <textarea class="obs-item" placeholder="Observações (opcional)"></textarea>
        </div>

        <div class="item">
          <div class="linha-item">
            <span class="nome-item">Filtro de ar</span>
            <label class="switch">
              <input type="checkbox" class="chk-item" data-nome="Filtro de ar" onclick="toggleColor(this)">
              <span class="slider"></span>
            </label>
          </div>
          <textarea class="obs-item" placeholder="Observações (opcional)"></textarea>
        </div>

        <div class="item">
          <div class="linha-item">
            <span class="nome-item">Evaporadora</span>
            <label class="switch">
              <input type="checkbox" class="chk-item" data-nome="Evaporadora" onclick="toggleColor(this)">
              <span class="slider"></span>
            </label>
          </div>
          <textarea class="obs-item" placeholder="Observações (opcional)"></textarea>
        </div>

        <div class="item">
          <div class="linha-item">
            <span class="nome-item">Condensadora</span>
            <label class="switch">
              <input type="checkbox" class="chk-item" data-nome="Condensadora" onclick="toggleColor(this)">
              <span class="slider"></span>
            </label>
          </div>
          <textarea class="obs-item" placeholder="Observações (opcional)"></textarea>
        </div>

        <h3 style="margin-top: 14px; font-size:16px;">Medições e limpeza</h3>

        <div class="item">
          <div class="linha-item">
            <span class="nome-item">Amperagem dentro do normal</span>
            <label class="switch">
              <input type="checkbox" class="chk-item" data-nome="Amperagem dentro do normal" onclick="toggleColor(this)">
              <span class="slider"></span>
            </label>
          </div>
          <textarea class="obs-item" placeholder="Observações (opcional)"></textarea>
        </div>

        <div class="item">
          <div class="linha-item">
            <span class="nome-item">Pressões do sistema dentro da faixa</span>
            <label class="switch">
              <input type="checkbox" class="chk-item" data-nome="Pressões do sistema dentro da faixa" onclick="toggleColor(this)">
              <span class="slider"></span>
            </label>
          </div>
          <textarea class="obs-item" placeholder="Observações (opcional)"></textarea>
        </div>

        <div class="item">
          <div class="linha-item">
            <span class="nome-item">Refrigerante / gás em condição adequada</span>
            <label class="switch">
              <input type="checkbox" class="chk-item" data-nome="Refrigerante / gás em condição adequada" onclick="toggleColor(this)">
              <span class="slider"></span>
            </label>
          </div>
          <textarea class="obs-item" placeholder="Observações (opcional)"></textarea>
        </div>

        <div class="item">
          <div class="linha-item">
            <span class="nome-item">Estado geral da máquina</span>
            <label class="switch">
              <input type="checkbox" class="chk-item" data-nome="Estado geral de limpeza satisfatório" onclick="toggleColor(this)">
              <span class="slider"></span>
            </label>
          </div>
          <textarea class="obs-item" placeholder="Observações (opcional)"></textarea>
        </div>

        <div class="item">
          <div class="linha-item">
            <span class="nome-item">Limpeza da condensadora</span>
            <label class="switch">
              <input type="checkbox" class="chk-item" data-nome="Limpeza da condensadora" onclick="toggleColor(this)">
              <span class="slider"></span>
            </label>
          </div>
          <textarea class="obs-item" placeholder="Observações (opcional)"></textarea>
        </div>

        <button class="btn-obs" type="button" onclick="toggleObs()">+ Adicionar observações técnicas</button>

        <div id="obsTecnicaBox">
          <textarea id="obsTecnicasGerais" placeholder="Escreva observações técnicas detalhadas..."></textarea>
        </div>

        <!-- type="button" pra NÃO submeter o <form> automático -->
        <button class="btn-salvar" type="button" onclick="salvarChecklistPmoc(event)">Salvar checklist</button>
      </div>
    </div>
  </form>

  <script>
  // URL da API
  const API_PMOC_URL = "https://aircontrolos-api.onrender.com/api/PmocRegistros";

  // Carrega unidade salva (pra preencher campos Unidade / Local)
  (function carregarUnidade() {
    const unidadeSelecionadaStr = localStorage.getItem("pmocUnidadeSelecionada");
    if (!unidadeSelecionadaStr) return;

    try {
      const unidadeSel = JSON.parse(unidadeSelecionadaStr);
      const campoUnidade = document.getElementById("unidade");
      const campoLocal   = document.getElementById("local");

      if (campoUnidade && !campoUnidade.value) {
        campoUnidade.value = unidadeSel.nome || "";
      }
      if (campoLocal && !campoLocal.value) {
        campoLocal.value = unidadeSel.cidade || "";
      }
    } catch (e) {
      console.warn("Não foi possível ler pmocUnidadeSelecionada:", e);
    }
  })();

  // Mostrar / esconder observações técnicas gerais
  function toggleObs() {
    const box = document.getElementById("obsTecnicaBox");
    if (!box) return;
    box.style.display =
      box.style.display === "none" || box.style.display === "" ? "block" : "none";
  }

  // Marca/desmarca item como problema (muda cor do switch pelo CSS input.problem + .slider)
  function toggleColor(el) {
    el.classList.toggle("problem");
  }

  // Se abrir com #pops, rola direto pra sessão dos POPs
  document.addEventListener("DOMContentLoaded", () => {
    if (window.location.hash === "#pops") {
      const popsSection = document.getElementById("popsSection");
      if (popsSection) {
        popsSection.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    }
  });

  // -------- SALVAR CHECKLIST --------
  async function salvarChecklistPmoc(e) {
    // 1) Validar ID do aparelho
    const aparelhoHdvInput = document.getElementById("aparelhoHdvId");
    const aparelhoHdvIdStr = (aparelhoHdvInput?.value || "").trim();

    if (!aparelhoHdvIdStr) {
      alert("Informe o ID do aparelho (HDV).");
      return;
    }

    const aparelhoHdvId = parseInt(aparelhoHdvIdStr, 10);
    if (Number.isNaN(aparelhoHdvId)) {
      alert("O ID do aparelho (HDV) deve ser um número inteiro.");
      return;
    }

    // 2) Montar itens do checklist
    const checkboxes  = document.querySelectorAll(".chk-item");
    const observacoes = document.querySelectorAll(".obs-item");

    const itens = [];
    checkboxes.forEach((chk, index) => {
      const nome      = chk.dataset.nome || `Item ${index + 1}`;
      const problema  = chk.classList.contains("problem");
      const obs       = (observacoes[index]?.value || "").trim();

      itens.push({
        nome: nome,
        ok: !problema,
        problema: problema,
        observacao: obs
      });
    });

    // 3) Campos extras
    const dataField  = document.getElementById("data");
    const dataValor  = dataField?.value || "";
    const obsTecText = document.getElementById("obsTecnicasGerais");
    const obsTec     = obsTecText?.value || "";

    // 3.1) Nome do técnico preenchido manualmente
     const nomeTecnicoInput = document.getElementById("nomeTecnicoInput");
     const tecnicoNome = (nomeTecnicoInput?.value || "").trim() || localStorage.getItem("usuarioNome") || "Técnico";
     const tecnicoEmail = localStorage.getItem("usuarioEmail") || "sem@email.com";

    // 4) Montar payload do POST
    const payload = {
    aparelhoHdvId: aparelhoHdvId,
    data: new Date().toISOString(), // sempre usa data e hora atual
    checklistJson: JSON.stringify(itens),
    observacoesTecnicas: obsTec,
    tecnicoNome: tecnicoNome,
    tecnicoEmail: tecnicoEmail
    };

    console.log("Data que será enviada:", payload.data);

    try {
      const resp = await fetch(API_PMOC_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        const txt = await resp.text();
        console.error("Erro da API:", txt);
        alert("Erro ao salvar checklist no servidor.");
        return;
      }

      // SUCESSO
      alert("Checklist salvo com sucesso!");

      // Limpar formulário
      const formPmoc = document.getElementById("formPmoc");
      if (formPmoc) {
        formPmoc.reset();
      }

      document.querySelectorAll(".chk-item").forEach(chk => {
        chk.classList.remove("problem");
      });

      const box = document.getElementById("obsTecnicaBox");
      if (box) {
        box.style.display = "none";
      }

    } catch (err) {
      console.error("Erro de rede ao salvar PMOC:", err);
      alert("Erro de comunicação com o servidor.");
    }
  }
</script>








