<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checklist PMOC</title>

  <style>
    body {
      margin: 0;
      background: #f3f4f6;
      font-family: Arial, sans-serif;
    }

    .topo {
      background: #007bff;
      color: white;
      padding: 16px;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .voltar {
      background: rgba(255,255,255,0.25);
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      color: white;
      font-size: 14px;
    }

    .container {
      max-width: 900px;
      margin: auto;
      padding: 16px;
    }

    .card {
      background: white;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    h2 {
      margin-top: 0;
      font-size: 18px;
    }

    .grid {
      display: grid;
      gap: 12px;
    }

    .campo label {
      font-size: 13px;
      color: #555;
    }

    .campo input {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .item {
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }

    .linha-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .nome-item {
      font-size: 15px;
      font-weight: 600;
    }

    /* SWITCH */
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #37d67a; /* verde padr√£o */
      transition: 0.2s;
      border-radius: 999px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: 0.2s;
      border-radius: 50%;
    }

    /* vermelho quando "problema" */
    .switch input.problem + .slider {
      background-color: #ff4d4d !important;
    }

    .switch input.problem + .slider:before {
      transform: translateX(20px);
    }

    textarea {
      width: 100%;
      margin-top: 8px;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      resize: vertical;
    }

    .btn-obs {
      width: 100%;
      padding: 10px;
      background: #e7f1ff;
      border: 1px solid #70a9ff;
      border-radius: 8px;
      color: #0056c7;
      cursor: pointer;
      margin-top: 10px;
    }

    #obsTecnicaBox {
      margin-top: 10px;
      display: none;
    }

    .btn-salvar {
      width: 100%;
      background: #007bff;
      border: none;
      padding: 14px;
      color: white;
      font-size: 16px;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 18px;
    }

    .pops-links {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .btn-pop {
      display: inline-block;
      padding: 8px 12px;
      border-radius: 8px;
      background: #f1f5f9;
      border: 1px solid #cbd5f5;
      font-size: 13px;
      text-decoration: none;
      color: #0056c7;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-pop:hover {
      background: #e2ecff;
    }
  </style>
</head>

<body>
  <div class="topo">
    <button class="voltar" onclick="window.location.href='dashboard.html'">‚Üê</button>
    Checklist PMOC
  </div>

  <!-- FORM PMOC -->
  <form id="formPmoc">
    <div class="container">

      <!-- Dados do aparelho -->
      <div class="card">
        <h2>Dados do aparelho</h2>

        <div class="grid">
          <div class="campo">
            <label>ID do aparelho (HDV)</label>
            <input id="aparelhoHdvId" type="number" placeholder="Ex.: 2, 3, 10, 90" />
          </div>

          <div class="campo">
            <label>Patrim√¥nio</label>
            <input id="patrimonio" type="text">
          </div>

          <div class="campo">
            <label>Unidade</label>
            <input id="unidade" type="text">
          </div>

          <div class="campo">
            <label>Local</label>
            <input id="local" type="text">
          </div>

          <div class="campo">
            <label>Marca</label>
            <input id="marca" type="text">
          </div>

          <div class="campo">
            <label>BTUs</label>
            <input id="btu" type="text">
          </div>

          <div class="campo">
            <label>Modelo</label>
            <input id="modelo" type="text">
          </div>

          <div class="campo">
            <label>Data</label>
            <input id="data" type="date">
          </div>
        </div>
      </div>

      <!-- POPs -->
      <div class="card" id="popsSection">
        <h2>POPs / Orienta√ß√µes gerais</h2>
        <p style="font-size:13px; margin-top:4px;">
          Abaixo est√£o os POPs gerais de higieniza√ß√£o, instala√ß√£o e testes.
          Eles abrem em outra aba para consulta durante o checklist.
        </p>

        <div class="pops-links">
          <a href="docs/POP_Higienizacao_Ar_Condicionado_Split.pdf" target="_blank" class="btn-pop">
            POP ‚Äì Higieniza√ß√£o Split
          </a>

          <a href="docs/POP_Instalacao_Ar_Condicionado_Split.pdf" target="_blank" class="btn-pop">
            POP ‚Äì Instala√ß√£o Split
          </a>

          <a href="docs/POP_Teste_e_Troca_Capacitor.pdf" target="_blank" class="btn-pop">
            POP ‚Äì Teste e troca de capacitor
          </a>

          <a href="docs/Fichas_de_Monitoramento.pdf" target="_blank" class="btn-pop">
            Fichas de monitoramento
          </a>

          <a href="docs/Teste_Compressor_e_Motoventilador.pdf" target="_blank" class="btn-pop">
            POP ‚Äì Teste de compressor e moto-ventilador
          </a>
        </div>
      </div>

      <!-- CHECKLIST -->
      <div class="card">
        <h2>Checklist</h2>

        <div class="item">
          <div class="linha-item">
            <span class="nome-item">Funcionamento geral</span>
            <label class="switch">
              <input type="checkbox" class="chk-item" data-nome="Funcionamento geral" onclick="toggleColor(this)">
              <span class="slider"></span>
            </label>
          </div>
          <textarea class="obs-item" placeholder="Observa√ß√µes (opcional)"></textarea>
        </div>

        <div class="item">
          <div class="linha-item">
            <span class="nome-item">Filtro de ar</span>
            <label class="switch">
              <input type="checkbox" class="chk-item" data-nome="Filtro de ar" onclick="toggleColor(this)">
              <span class="slider"></span>
            </label>
          </div>
          <textarea class="obs-item" placeholder="Observa√ß√µes (opcional)"></textarea>
        </div>

        <div class="item">
          <div class="linha-item">
            <span class="nome-item">Evaporadora</span>
            <label class="switch">
              <input type="checkbox" class="chk-item" data-nome="Evaporadora" onclick="toggleColor(this)">
              <span class="slider"></span>
            </label>
          </div>
          <textarea class="obs-item" placeholder="Observa√ß√µes (opcional)"></textarea>
        </div>

        <div class="item">
          <div class="linha-item">
            <span class="nome-item">Condensadora</span>
            <label class="switch">
              <input type="checkbox" class="chk-item" data-nome="Condensadora" onclick="toggleColor(this)">
              <span class="slider"></span>
            </label>
          </div>
          <textarea class="obs-item" placeholder="Observa√ß√µes (opcional)"></textarea>
        </div>

        <h3 style="margin-top: 14px; font-size:16px;">Medi√ß√µes e limpeza</h3>

        <div class="item">
          <div class="linha-item">
            <span class="nome-item">Amperagem dentro do normal</span>
            <label class="switch">
              <input type="checkbox" class="chk-item" data-nome="Amperagem dentro do normal" onclick="toggleColor(this)">
              <span class="slider"></span>
            </label>
          </div>
          <textarea class="obs-item" placeholder="Observa√ß√µes (opcional)"></textarea>
        </div>

        <div class="item">
          <div class="linha-item">
            <span class="nome-item">Press√µes do sistema dentro da faixa</span>
            <label class="switch">
              <input type="checkbox" class="chk-item" data-nome="Press√µes do sistema dentro da faixa" onclick="toggleColor(this)">
              <span class="slider"></span>
            </label>
          </div>
          <textarea class="obs-item" placeholder="Observa√ß√µes (opcional)"></textarea>
        </div>

        <div class="item">
          <div class="linha-item">
            <span class="nome-item">Refrigerante / g√°s em condi√ß√£o adequada</span>
            <label class="switch">
              <input type="checkbox" class="chk-item" data-nome="Refrigerante / g√°s em condi√ß√£o adequada" onclick="toggleColor(this)">
              <span class="slider"></span>
            </label>
          </div>
          <textarea class="obs-item" placeholder="Observa√ß√µes (opcional)"></textarea>
        </div>

        <div class="item">
          <div class="linha-item">
            <span class="nome-item">Estado geral da m√°quina</span>
            <label class="switch">
              <input type="checkbox" class="chk-item" data-nome="Estado geral de limpeza satisfat√≥rio" onclick="toggleColor(this)">
              <span class="slider"></span>
            </label>
          </div>
          <textarea class="obs-item" placeholder="Observa√ß√µes (opcional)"></textarea>
        </div>

        <div class="item">
          <div class="linha-item">
            <span class="nome-item">Limpeza da condensadora</span>
            <label class="switch">
              <input type="checkbox" class="chk-item" data-nome="Limpeza da condensadora" onclick="toggleColor(this)">
              <span class="slider"></span>
            </label>
          </div>
          <textarea class="obs-item" placeholder="Observa√ß√µes (opcional)"></textarea>
        </div>

        <button class="btn-obs" type="button" onclick="toggleObs()">+ Adicionar observa√ß√µes t√©cnicas</button>

        <div id="obsTecnicaBox">
          <textarea id="obsTecnicasGerais" placeholder="Escreva observa√ß√µes t√©cnicas detalhadas..."></textarea>
        </div>

        <!-- type="button" pra N√ÉO submeter o <form> autom√°tico -->
        <button class="btn-salvar" id="btnSalvarPmoc" type="button">Salvar checklist</button>
      </div>
    </div>
  </form>

  <script>
    // ===================== CONFIG =====================
    const API_PMOC_URL = "https://aircontrolos-api.onrender.com/api/PmocRegistros/salvar";

    // ===================== FUN√á√ïES DE UI =====================
    function toggleObs() {
      const box = document.getElementById("obsTecnicaBox");
      if (!box) return;
      box.style.display = (box.style.display === "none" || box.style.display === "") ? "block" : "none";
    }

    function toggleColor(el) {
      el.classList.toggle("problem");
    }

    // ===================== CARREGAR UNIDADE =====================
    (function carregarUnidadeSelecionada() {
      const unidadeSelecionadaStr = localStorage.getItem("pmocUnidadeSelecionada");
      if (!unidadeSelecionadaStr) return;

      try {
        const unidadeSel = JSON.parse(unidadeSelecionadaStr);
        const campoUnidade = document.getElementById("unidade");
        const campoLocal   = document.getElementById("local");

        if (campoUnidade && !campoUnidade.value) {
          campoUnidade.value = unidadeSel.nome || "";
        }
        if (campoLocal && !campoLocal.value) {
          campoLocal.value = unidadeSel.cidade || "";
        }
      } catch (e) {
        console.warn("N√£o foi poss√≠vel ler pmocUnidadeSelecionada:", e);
      }
    })();

    // ===================== DOM READY =====================
    document.addEventListener("DOMContentLoaded", () => {
      // rolagem autom√°tica pros POPs se vier com hash
      if (window.location.hash === "#pops") {
        const popsSection = document.getElementById("popsSection");
        if (popsSection) {
          popsSection.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      }

      const btnSalvar = document.getElementById("btnSalvarPmoc");
      if (btnSalvar) {
        btnSalvar.addEventListener("click", salvarChecklistPmoc);
      }
    });

    // ===================== SALVAR CHECKLIST =====================
    async function salvarChecklistPmoc() {
      // 1) Validar ID do aparelho
      const aparelhoHdvIdStr = document.getElementById("aparelhoHdvId").value.trim();
      if (!aparelhoHdvIdStr) {
        alert("Informe o ID do aparelho (HDV).");
        return;
      }

      const aparelhoHdvId = parseInt(aparelhoHdvIdStr, 10);
      if (Number.isNaN(aparelhoHdvId)) {
        alert("O ID do aparelho (HDV) deve ser um n√∫mero inteiro.");
        return;
      }

      // 2) Montar o checklist (array de itens)
      const checkboxes  = document.querySelectorAll(".chk-item");
      const observacoes = document.querySelectorAll(".obs-item");

      const itens = [];
      checkboxes.forEach((chk, index) => {
        const nome     = chk.dataset.nome || `Item ${index + 1}`;
        const problema = chk.classList.contains("problem");  // true = problema (vermelho)
        const obs      = observacoes[index].value.trim();

        itens.push({
          nome: nome,
          ok: !problema,
          problema: problema,
          observacao: obs
        });
      });

      // 3) Campos adicionais
      const dataCampo          = document.getElementById("data").value; // yyyy-MM-dd
      const obsTecnicasGerais  = document.getElementById("obsTecnicasGerais")?.value || "";

      // 4) Pega o nome do usu√°rio logado
      let tecnicoNome = "";
      try {
        const userStr = sessionStorage.getItem("air_user") || localStorage.getItem("air_user");
        if (userStr) {
          const u = JSON.parse(userStr);
          tecnicoNome = u.nome || u.email || "";
        }
      } catch (e) {
        console.warn("N√£o foi poss√≠vel ler usu√°rio logado:", e);
      }

      // 5) Monta o payload que vai pra API
      const payload = {
        aparelhoHdvId: aparelhoHdvId,
        data: dataCampo || null,
        checklistJson: JSON.stringify(itens),   // nome IGUAL ao DTO
        observacoesTecnicas: obsTecnicasGerais,
        tecnicoNome: tecnicoNome               // salva o nome de quem fez
      };

      console.log("Enviando payload PMOC:", payload);

      try {
        const resp = await fetch(API_PMOC_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (!resp.ok) {
          const erroTxt = await resp.text();
          console.error("Erro da API:", erroTxt);
          alert("Erro ao salvar checklist no servidor.");
          return;
        }

        alert("Checklist salvo com sucesso!");

        // üî• LIMPA O FORM E VOLTA SWITCHES PARA VERDE
        const formPmoc = document.getElementById("formPmoc");
        if (formPmoc) formPmoc.reset();

        document.querySelectorAll(".chk-item").forEach(chk => {
          chk.classList.remove("problem");
        });

        const box = document.getElementById("obsTecnicaBox");
        if (box) box.style.display = "none";

      } catch (e) {
        console.error("Erro de rede ao salvar PMOC:", e);
        alert("Erro de comunica√ß√£o com o servidor.");
      }
    }
  </script>
</body>
</html>
