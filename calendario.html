<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calend√°rio de OS - AirControl OS</title>

  <link rel="stylesheet" href="css/style.css" />

  <!-- FullCalendar CSS -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">

  <style>
    .page-calendario .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px 16px;
    }

    .layout-calendario {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      align-items: flex-start;
    }

    #calendar {
      background: #fff;
      border-radius: 14px;
      padding: 10px;
      box-shadow: 0 10px 25px rgba(15,23,42,.08);
    }

    .filtros-calendario {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .filtros-calendario label {
      font-weight: 600;
    }

    .filtros-calendario input[type="month"] {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #dbe2ea;
    }

    .painel-dia {
      background: #fff;
      border-radius: 14px;
      padding: 14px 16px;
      box-shadow: 0 10px 25px rgba(15,23,42,.08);
      min-height: 260px;
      display: flex;
      flex-direction: column;
    }

    .painel-dia h2 {
      font-size: 1.1rem;
      margin: 0 0 4px;
    }

    .painel-dia small {
      color: #64748b;
    }

    #listaDia {
      margin-top: 8px;
      flex: 1;
      max-height: 400px;
      overflow-y: auto; /* rolagem quando tiver muitas OS */
    }

    .os-card {
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      padding: 8px 10px;
      margin-top: 8px;
      font-size: .9rem;
    }

    .os-card strong {
      display: block;
      margin-bottom: 4px;
    }

    .os-card span.badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: .75rem;
      margin-right: 4px;
    }

    .badge-prio-Alta   { background:#fee2e2; color:#b91c1c; }
    .badge-prio-M√©dia  { background:#fef3c7; color:#92400e; }
    .badge-prio-Baixa  { background:#dcfce7; color:#166534; }

    .badge-status-Aberta        { background:#dbeafe; color:#1d4ed8; }
    .badge-status-Em\ Andamento { background:#fef9c3; color:#92400e; }
    .badge-status-Conclu√≠da     { background:#bbf7d0; color:#166534; }

    /* bot√£o PDF */
    #btnExportPDF {
      margin-top: 12px;
      padding: 8px 16px;
      border-radius: 999px;
      border: 0;
      background: #1e90ff;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      align-self: flex-start;
      display: none; /* s√≥ mostra quando tiver OS */
    }

    .loader {
      font-size: .9rem;
      color: #64748b;
      margin-top: 4px;
    }

    /* dias clic√°veis */
    .fc-daygrid-day-frame {
      cursor: pointer;
    }

    @media (max-width: 900px) {
      .layout-calendario {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body class="page-calendario">
  <!-- script principal com API_BASE, api(), getOS(), toItems() etc. -->
  <script src="js/script.js"></script>

  <header class="topbar-lite"
          style="border-radius:0 0 18px 18px; background:linear-gradient(90deg,#1e90ff,#0ea5e9); color:#fff; padding:16px 0;">
    <div class="wrap">
      <h1 style="margin:0; font-size:1.4rem;">üìÖ Calend√°rio de OS ‚Äì AirControl OS</h1>
      <p class="muted" style="color:#e2f3ff;">Visualize as ordens de servi√ßo por dia.</p>
    </div>
  </header>

  <main class="wrap">
    <div class="filtros-calendario">
      <label for="mesRef">M√™s:</label>
      <input type="month" id="mesRef">
      <span class="muted">Mostrando OS pela data de abertura/cria√ß√£o.</span>
      <span id="loaderMes" class="loader" style="display:none;">Carregando OS...</span>
    </div>

    <div class="layout-calendario">
      <div id="calendar"></div>

      <aside id="painelDia" class="painel-dia">
        <h2 id="tituloDia">OS do dia</h2>
        <small>Selecione um dia no calend√°rio para ver as OS.</small>
        <div id="listaDia"></div>
        <button id="btnExportPDF">
          Baixar relat√≥rio do dia
        </button>
      </aside>
    </div>
  </main>

  <!-- Scripts das libs -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <!-- jsPDF para gerar PDF -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
    crossorigin="anonymous"
    referrerpolicy="no-referrer">
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      // Se quiser, pode exigir login aqui:
      // requireLogin();

      const calendarEl   = document.getElementById("calendar");
      const mesInput     = document.getElementById("mesRef");
      const loaderMes    = document.getElementById("loaderMes");
      const painelDia    = document.getElementById("painelDia");
      const listaDia     = document.getElementById("listaDia");
      const btnExportPDF = document.getElementById("btnExportPDF");
      const tituloDiaEl  = document.getElementById("tituloDia");

      // Cada item:
      // {
      //   dataRef, codigo, cliente, descricao, prioridade, status,
      //   tecnico, dataAbertura, dataConclusao
      // }
      let osDoMes = [];
      let osSelecionadasDia = [];

      // --------- Helpers de data/c√≥digo ---------
      function normalizarDataDia(valor) {
        if (!valor) return null;
        if (typeof valor === "string" && valor.length >= 10) {
          return valor.slice(0, 10); // "yyyy-mm-dd"
        }
        try {
          const d = valor instanceof Date ? valor : new Date(valor);
          return d.toISOString().slice(0, 10);
        } catch {
          return null;
        }
      }

      function formatarDataHora(valor) {
        if (!valor) return "-";
        try {
          const d = new Date(valor);
          return d.toLocaleString("pt-BR");
        } catch {
          return "-";
        }
      }

      function calcularDuracao(ini, fim) {
        if (!ini || !fim) return "Em aberto";
        try {
          const d1 = new Date(ini);
          const d2 = new Date(fim);
          const ms = d2.getTime() - d1.getTime();
          if (ms <= 0) return "‚Äî";

          let minutosTotais = Math.round(ms / 60000);
          const dias = Math.floor(minutosTotais / (60 * 24));
          minutosTotais -= dias * 60 * 24;
          const horas = Math.floor(minutosTotais / 60);
          const minutos = minutosTotais % 60;

          const partes = [];
          if (dias > 0) partes.push(`${dias} dia${dias > 1 ? "s" : ""}`);
          if (horas > 0) partes.push(`${horas} h`);
          if (minutos > 0) partes.push(`${minutos} min`);

          return partes.join(" ") || "‚Äî";
        } catch {
          return "‚Äî";
        }
      }

      // Gera c√≥digo no formato OS-ANO-XXX (igual ao dashboard)
      function gerarCodigoOS(id, dataAbertura) {
        try {
          const ano = dataAbertura
            ? new Date(dataAbertura).getFullYear()
            : new Date().getFullYear();
          const seq = String(id ?? 0).padStart(3, "0");
          return `OS-${ano}-${seq}`;
        } catch {
          const seq = String(id ?? 0).padStart(3, "0");
          return `OS-${seq}`;
        }
      }

      // --------- Painel lateral do dia ---------
      function atualizarPainelDia(dateStr) {
        const dataBonita = new Date(dateStr + "T00:00:00");
        const textoTitulo = "OS do dia " + dataBonita.toLocaleDateString("pt-BR");

        if (tituloDiaEl) {
          tituloDiaEl.textContent = textoTitulo;
        }

        const osDoDia = osDoMes.filter(os => os.dataRef === dateStr);
        osSelecionadasDia = osDoDia;

        listaDia.innerHTML = "";

        if (!osDoDia.length) {
          listaDia.innerHTML = "<p class='muted'>Nenhuma OS registrada neste dia.</p>";
          btnExportPDF.style.display = "none";
          return;
        }

        osDoDia.forEach(os => {
          const prio    = os.prioridade || "Baixa";
          const status  = os.status || "Aberta";
          const cliente = os.cliente || "-";
          const desc    = os.descricao || "-";
          const tecnico = os.tecnico || "-";
          const codigo  = os.codigo || "-";

          const card = document.createElement("div");
          card.className = "os-card";
          card.innerHTML = `
            <strong>OS: ${codigo} ‚Äì ${cliente}</strong>
            <div style="margin-bottom:4px;">
              <span class="badge badge-prio-${prio}">
                Prioridade: ${prio}
              </span>
              <span class="badge badge-status-${status.replace(" ", "\\ ")}`}>
                Status: ${status}
              </span>
            </div>
            <div style="margin-bottom:4px;"><em>T√©cnico:</em> ${tecnico}</div>
            <div>${desc}</div>
          `;
          listaDia.appendChild(card);
        });

        btnExportPDF.style.display = "inline-block";
      }

      // --------- FullCalendar ---------
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        locale: "pt-br",
        height: "auto",
        headerToolbar: {
          left: "prev,next today",
          center: "title",
          right: ""
        },
        dateClick: info => {
          atualizarPainelDia(info.dateStr);
        }
      });
      calendar.render();

      // --------- Carregar OS do m√™s ---------
      async function carregarEventosDoMes(ano, mes) {
        loaderMes.style.display = "inline";
        osDoMes = [];

        try {
          // 1) Tenta usar OS OFFLINE (se existirem)
          const offline = getOS();
          if (offline && offline.length) {
            offline.forEach(os => {
              const dataRef = normalizarDataDia(os.criadoEm || os.dataAbertura);
              if (!dataRef) return;

              osDoMes.push({
                dataRef,
                codigo: os.codigo || "-",  // n√∫mero da OS offline
                cliente: os.localNome || (os.local && os.local.endereco) || "-",
                descricao: os.descricao || "-",
                prioridade: os.prioridade || "Baixa",
                status: os.status || "Aberta",
                tecnico: os.tecnico || "-",
                dataAbertura: os.criadoEm || os.dataAbertura || null,
                dataConclusao: os.concluidaEm || os.dataConclusao || null
              });
            });

            console.log("[Calend√°rio] usando OS OFFLINE:", osDoMes.length);
          } else {
            // 2) Se n√£o tiver offline, busca na API ONLINE
            const resp = await api(`/api/OrdensServico?page=1&pageSize=500`);
            const itens = toItems(resp) || [];

            itens.forEach(os => {
              const dataRef = normalizarDataDia(os.dataAbertura);
              if (!dataRef) return;

              osDoMes.push({
                dataRef,
                codigo: gerarCodigoOS(os.id, os.dataAbertura), // n√∫mero da OS online
                cliente: (os.cliente && os.cliente.nome) || os.local || "-",
                descricao: os.descricao || "-",
                prioridade: os.prioridade || "Baixa",
                status: os.status || "Aberta",
                tecnico: (os.tecnico && os.tecnico.nome) || "-",
                dataAbertura: os.dataAbertura || null,
                dataConclusao: os.dataConclusao || null
              });
            });

            console.log("[Calend√°rio] usando OS ONLINE:", osDoMes.length);
          }

          // Filtra por m√™s selecionado (ano/mes)
          const eventos = osDoMes
            .filter(os => {
              const [y, m] = os.dataRef.split("-").map(Number);
              return y === ano && m === mes;
            })
            .map(os => ({
              title: `${os.codigo} - ${os.cliente}`.slice(0, 40),
              start: os.dataRef,
              allDay: true
            }));

          calendar.removeAllEvents();
          calendar.addEventSource(eventos);
          calendar.gotoDate(new Date(ano, mes - 1, 1));

        } catch (e) {
          console.warn("Falha ao carregar OS para o calend√°rio:", e);
          alert("N√£o foi poss√≠vel carregar as OS para o calend√°rio.");
        } finally {
          loaderMes.style.display = "none";
        }
      }

      // M√™s atual
      const hoje = new Date();
      mesInput.value =
        `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2,"0")}`;

      await carregarEventosDoMes(hoje.getFullYear(), hoje.getMonth() + 1);

      mesInput.addEventListener("change", async (e) => {
        const [ano, mes] = e.target.value.split("-").map(Number);
        if (!ano || !mes) return;
        await carregarEventosDoMes(ano, mes);
      });

      // ---------- Exportar dia em PDF ----------
      btnExportPDF.addEventListener("click", () => {
        if (!osSelecionadasDia || !osSelecionadasDia.length) {
          alert("N√£o h√° OS para este dia.");
          return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: "portrait",
          unit: "mm",
          format: "a4"
        });

        // Margens aproximadas (ABNT)
        const marginLeft = 20;
        const marginTop  = 20;
        const lineHeight = 7;
        const pageHeight = doc.internal.pageSize.getHeight();
        const pageWidth  = doc.internal.pageSize.getWidth();
        let y = marginTop;

        doc.setFont("Times", "normal");
        doc.setFontSize(12);

        // Cabe√ßalho
        doc.text("AirControl OS - Sistema de Ordens de Servi√ßo", marginLeft, y);
        y += lineHeight;
        doc.text("Relat√≥rio di√°rio de ordens de servi√ßo", marginLeft, y);
        y += lineHeight * 2;

        // T√≠tulo centralizado
        const titulo = tituloDiaEl
          ? tituloDiaEl.textContent
          : "OS do dia";
        doc.setFont("Times", "bold");
        doc.setFontSize(14);
        doc.text(
          titulo,
          pageWidth / 2,
          y,
          { align: "center" }
        );
        y += lineHeight * 2;

        // Data de emiss√£o
        doc.setFont("Times", "normal");
        doc.setFontSize(12);
        const hojeStr = new Date().toLocaleDateString("pt-BR");
        doc.text(`Data de emiss√£o: ${hojeStr}`, marginLeft, y);
        y += lineHeight * 2;

        const larguraUtil = pageWidth - marginLeft * 2;

        // Corpo ‚Äì lista de OS
        osSelecionadasDia.forEach((os, index) => {
          if (y > pageHeight - 30) {
            doc.addPage();
            y = marginTop;
          }

          const dataAberturaStr  = formatarDataHora(os.dataAbertura);
          const dataConclusaoStr = formatarDataHora(os.dataConclusao);
          const duracaoStr       = calcularDuracao(os.dataAbertura, os.dataConclusao);

          doc.setFont("Times", "bold");
          doc.text(`${index + 1}. Cliente: ${os.cliente}`, marginLeft, y);
          y += lineHeight;

          doc.setFont("Times", "normal");
          doc.text(`N√∫mero da OS: ${os.codigo || "-"}`, marginLeft, y);
          y += lineHeight;

          doc.text(`T√©cnico respons√°vel: ${os.tecnico}`, marginLeft, y);
          y += lineHeight;

          doc.text(`Prioridade: ${os.prioridade}`, marginLeft, y);
          y += lineHeight;

          doc.text(`Status: ${os.status}`, marginLeft, y);
          y += lineHeight;

          doc.text(`Data de abertura: ${dataAberturaStr}`, marginLeft, y);
          y += lineHeight;

          doc.text(`Data de conclus√£o: ${dataConclusaoStr}`, marginLeft, y);
          y += lineHeight;

          doc.text(`Tempo de servi√ßo (estimado): ${duracaoStr}`, marginLeft, y);
          y += lineHeight;

          const textoDesc = `Descri√ß√£o do servi√ßo: ${os.descricao}`;
          const linhasDesc = doc.splitTextToSize(textoDesc, larguraUtil);

          linhasDesc.forEach(l => {
            if (y > pageHeight - 30) {
              doc.addPage();
              y = marginTop;
            }
            doc.text(l, marginLeft, y);
            y += lineHeight;
          });

          // Linhas de assinatura
          if (y > pageHeight - 30) {
            doc.addPage();
            y = marginTop;
          }
          y += lineHeight;
          doc.text(
            "Assinatura do t√©cnico: ________________________________",
            marginLeft,
            y
          );
          y += lineHeight * 1.5;
          doc.text(
            "Assinatura do cliente: ________________________________",
            marginLeft,
            y
          );
          y += lineHeight * 2;
        });

        // Rodap√© com n√∫mero da p√°gina
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(10);
          doc.text(
            `AirControl OS - Relat√≥rio di√°rio   |   P√°gina ${i} de ${pageCount}`,
            marginLeft,
            pageHeight - 10
          );
        }

        const nomeArquivo = titulo
          .toLowerCase()
          .replace(/\s+/g, "-")
          .replace(/[^\w\-]/g, "");

        doc.save(`${nomeArquivo}.pdf`);
      });
    });
  </script>
</body>
</html>
