<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calend√°rio de OS - AirControl OS</title>

  <!-- CSS geral do app -->
  <link rel="stylesheet" href="css/style.css" />

  <!-- FullCalendar 5.11.0 (est√°vel, com CSS pr√≥prio, sem 404) -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css"
  />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js"></script>
</head>
<body class="page-calendario">
  <!-- script principal (API_BASE, api(), getOS(), toItems(), codigoOSApi etc.) -->
  <script src="js/script.js"></script>

  <header class="topbar-lite"
          style="border-radius:0 0 18px 18px; background:linear-gradient(90deg,#1e90ff,#0ea5e9); color:#fff; padding:16px 0;">
    <div class="wrap-calendario">
      <h1 style="margin:0; font-size:1.4rem;">üìÖ Calend√°rio de OS ‚Äì AirControl OS</h1>
      <p class="muted" style="color:#e2f3ff;">Visualize as ordens de servi√ßo por dia.</p>
    </div>
  </header>

  <main class="wrap-calendario">
    <div class="filtros-calendario">
      <label for="mesRef">M√™s:</label>
      <input type="month" id="mesRef" />
      <span class="muted">Mostrando OS pela data de abertura/cria√ß√£o.</span>
      <span id="loaderMes" class="loader" style="display:none;">Carregando OS...</span>
    </div>

    <div class="layout-calendario">
      <div id="calendarWrapper">
        <div id="calendar"></div>
      </div>

      <aside id="painelDia" class="painel-dia">
        <h2>OS do dia</h2>
        <small>Selecione um dia no calend√°rio para ver as OS.</small>
        <div id="listaDia"></div>
        <button id="btnRelatorioDia">Baixar relat√≥rio do dia</button>
      </aside>
    </div>
  </main>

  <!-- Lib do html2pdf (para gerar PDF do dia) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const calendarEl = document.getElementById("calendar");
      const mesInput   = document.getElementById("mesRef");
      const loaderMes  = document.getElementById("loaderMes");
      const painelDia  = document.getElementById("painelDia");
      const listaDia   = document.getElementById("listaDia");
      const btnPDF     = document.getElementById("btnRelatorioDia");

      // lista normalizada de OS do m√™s
      // { dataRef, clienteNome, tecnicoNome, numeroOS, prioridade, status,
      //   dtAbertura, dtConclusao, descricao }
      let osDoMes = [];
      let dataSelecionada = null; // yyyy-mm-dd

      function normalizarDataDia(valor) {
        if (!valor) return null;
        if (typeof valor === "string" && valor.length >= 10) {
          return valor.slice(0, 10);
        }
        try {
          const d = valor instanceof Date ? valor : new Date(valor);
          return d.toISOString().slice(0, 10);
        } catch {
          return null;
        }
      }

      function dataHoraBR(valor) {
        if (!valor) return "";
        try {
          const d = new Date(valor);
          return d.toLocaleString("pt-BR");
        } catch {
          return "";
        }
      }

      function atualizarPainelDia(dateStr) {
        dataSelecionada = dateStr;

        const dataBonita = new Date(dateStr + "T00:00:00");
        painelDia.querySelector("h2").textContent =
          "OS do dia " + dataBonita.toLocaleDateString("pt-BR");

        const osDoDia = osDoMes.filter(os => os.dataRef === dateStr);
        listaDia.innerHTML = "";

        if (!osDoDia.length) {
          listaDia.innerHTML = "<p class='muted'>Nenhuma OS registrada neste dia.</p>";
          btnPDF.style.display = "none";
          return;
        }

        osDoDia.forEach(os => {
          const card = document.createElement("div");
          card.className = "os-card";

          const prioridade = os.prioridade || "Baixa";
          const status     = os.status || "Aberta";

          card.innerHTML = `
            <strong>OS: ${os.numeroOS || "‚Äî"} ‚Äì ${os.clienteNome || "-"}</strong>
            <div style="margin-bottom:4px;">
              <span class="badge badge-prio-${prioridade}">
                Prioridade: ${prioridade}
              </span>
              <span class="badge badge-status-${status.replace(" ", "\\ ")}}">
                Status: ${status}
              </span>
            </div>
            <div style="margin-bottom:4px;"><strong>T√©cnico:</strong> ${os.tecnicoNome || "‚Äî"}</div>
            <div style="margin-bottom:4px;"><strong>Data de abertura:</strong> ${os.dtAbertura || "‚Äî"}</div>
            <div style="margin-bottom:4px;"><strong>Data de conclus√£o:</strong> ${os.dtConclusao || "‚Äî"}</div>
            <div><strong>Descri√ß√£o:</strong> ${os.descricao || "-"}</div>
          `;
          listaDia.appendChild(card);
        });

        btnPDF.style.display = "inline-block";
      }

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        locale: "pt-br",
        height: "auto",
        headerToolbar: {
          left: "prev,next today",
          center: "title",
          right: ""
        },
        dateClick: info => {
          atualizarPainelDia(info.dateStr);
        }
      });
      calendar.render();

      async function carregarEventosDoMes(ano, mes) {
        loaderMes.style.display = "inline";
        osDoMes = [];

        try {
          const offline = getOS && typeof getOS === "function" ? getOS() : null;

          if (offline && offline.length) {
            // dados OFFLINE
            offline.forEach(os => {
              const dataRef = normalizarDataDia(os.criadoEm || os.dataAbertura);
              if (!dataRef) return;

              osDoMes.push({
                dataRef,
                clienteNome: os.localNome || (os.local && os.local.endereco) || "-",
                tecnicoNome: os.tecnico || "-",
                numeroOS:    os.codigo || "‚Äî",
                prioridade:  os.prioridade || "Baixa",
                status:      os.status || "Aberta",
                dtAbertura:  dataHoraBR(os.criadoEm || os.dataAbertura),
                dtConclusao: os.concluidaEm ? dataHoraBR(os.concluidaEm) : "",
                descricao:   os.descricao || "-"
              });
            });
          } else {
            // dados ONLINE (API)
            const resp  = await api(`/api/OrdensServico?page=1&pageSize=500`);
            const itens = toItems(resp) || [];

            itens.forEach(os => {
              const dataRef = normalizarDataDia(os.dataAbertura);
              if (!dataRef) return;

              osDoMes.push({
                dataRef,
                clienteNome: (os.cliente && os.cliente.nome) || os.local || "-",
                tecnicoNome: (os.tecnico && os.tecnico.nome) || "-",
                numeroOS:    typeof codigoOSApi === "function" ? codigoOSApi(os) : (os.codigo || "‚Äî"),
                prioridade:  os.prioridade || "Baixa",
                status:      os.status || "Aberta",
                dtAbertura:  dataHoraBR(os.dataAbertura),
                dtConclusao: os.dataConclusao ? dataHoraBR(os.dataConclusao) : "",
                descricao:   os.descricao || "-"
              });
            });
          }

          // filtra pelo m√™s/ano selecionados
          const eventos = osDoMes
            .filter(os => {
              const [y, m] = os.dataRef.split("-").map(Number);
              return y === ano && m === mes;
            })
            .map(os => ({
              title: `${os.numeroOS || ""}`.trim(),
              start: os.dataRef,
              allDay: true
            }));

          calendar.removeAllEvents();
          calendar.addEventSource(eventos);
          calendar.gotoDate(new Date(ano, mes - 1, 1));
        } catch (e) {
          console.warn("Falha ao carregar OS para o calend√°rio:", e);
          alert("N√£o foi poss√≠vel carregar as OS para o calend√°rio.");
        } finally {
          loaderMes.style.display = "none";
        }
      }

      // m√™s atual
      const hoje = new Date();
      mesInput.value =
        `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2,"0")}`;

      await carregarEventosDoMes(hoje.getFullYear(), hoje.getMonth() + 1);

      mesInput.addEventListener("change", async (e) => {
        const [ano, mes] = e.target.value.split("-").map(Number);
        if (!ano || !mes) return;
        await carregarEventosDoMes(ano, mes);
      });

      // --------- PDF (estilo ficha, com 2 logos + quadros) ----------
      btnPDF.addEventListener("click", () => {
        if (!dataSelecionada) return;

        const osDoDia = osDoMes.filter(os => os.dataRef === dataSelecionada);
        if (!osDoDia.length) return;

        const dataHojeBR = new Date().toLocaleDateString("pt-BR");
        const dataDiaBR  = new Date(dataSelecionada + "T00:00:00").toLocaleDateString("pt-BR");

        const container = document.createElement("div");
        container.innerHTML = `
          <div style="font-family:'Times New Roman',serif; font-size:12pt; line-height:1.5;">

            <!-- LINHA DOS LOGOS -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin:0 0 14pt;">
              <img src="imagem/logo-prefeitura-sv.png"
                   style="height:70px; max-width:170px; object-fit:contain;"
                   alt="Prefeitura de S√£o Vicente" />
              <img src="imagem/logo-Maxi.png"
                   style="height:70px; max-width:170px; object-fit:contain;"
                   alt="Maxi Servi√ßos" />
            </div>

            <!-- T√çTULOS -->
            <h1 style="text-align:center; font-size:14pt; margin:0 0 4pt;">
              AirControl OS - Sistema de Ordens de Servi√ßo
            </h1>
            <h2 style="text-align:center; font-size:13pt; margin:0 0 12pt;">
              Relat√≥rio di√°rio de ordens de servi√ßo
            </h2>

            <!-- LINHA DATA EMISS√ÉO -->
            <p style="text-align:right; margin:0 4pt 12pt 4pt; width:100%;">
              Data de emiss√£o: ${dataHojeBR}
            </p>

            <h3 style="text-align:center; font-size:13pt; margin:0 0 14pt;">
              OS do dia ${dataDiaBR}
            </h3>

            ${osDoDia.map((os, idx) => `
              <div style="margin-bottom:18pt; border:1px solid #000; padding:8pt 10pt;">
                <p style="margin:0 0 4pt;"><strong>${idx + 1}. Cliente:</strong> ${os.clienteNome}</p>
                <p style="margin:0 0 4pt;"><strong>N√∫mero da OS:</strong> ${os.numeroOS || "‚Äî"}</p>
                <p style="margin:0 0 4pt;"><strong>T√©cnico respons√°vel:</strong> ${os.tecnicoNome || "‚Äî"}</p>
                <p style="margin:0 0 4pt;"><strong>Prioridade:</strong> ${os.prioridade}</p>
                <p style="margin:0 0 4pt;"><strong>Status:</strong> ${os.status}</p>
                <p style="margin:0 0 4pt;"><strong>Data de abertura:</strong> ${os.dtAbertura || "‚Äî"}</p>
                <p style="margin:0 0 8pt;"><strong>Data de conclus√£o:</strong> ${os.dtConclusao || "‚Äî"}</p>
                <p style="margin:0 0 8pt;"><strong>Descri√ß√£o do servi√ßo:</strong> ${os.descricao}</p>

                <p style="margin:0 0 18pt;">
                  Tempo de servi√ßo (estimado): ________________________________
                </p>

                <p style="margin:0 0 12pt;">
                  Assinatura do t√©cnico: _____________________________________________
                </p>
                <p style="margin:0;">
                  Assinatura do respons√°vel pela unidade: _____________________________
                </p>
              </div>
            `).join("")}

            <p style="margin-top:16pt; font-size:10pt;">
              Relat√≥rio gerado automaticamente pelo sistema AirControl OS.
            </p>
          </div>
        `;

        const opt = {
          margin:       [20, 20, 20, 20],
          filename:     `os-do-dia-${dataSelecionada.replace(/-/g,"")}.pdf`,
          html2canvas:  { scale: 2 },
          jsPDF:        { unit: "mm", format: "a4", orientation: "portrait" }
        };

        html2pdf().set(opt).from(container).save();
      });
    });
  </script>
</body>
</html>
