<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nova OS - Sistemas Maxi</title>

  <link rel="stylesheet" href="css/style.css" />

  <!-- BRAND TOGGLE -->
  <link id="app-manifest" rel="manifest" href="manifest.webmanifest" />
  <link id="apple-icon" rel="apple-touch-icon" href="icons/empresa/icon-192.png" />
  <link id="favicon" rel="icon" href="icons/empresa/icon-192.png" />
  <meta name="theme-color" content="#1e90ff" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <script>
    const BRAND = localStorage.getItem('brand') || 'empresa';
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('apple-icon').href = `icons/${BRAND}/icon-192.png`;
      document.getElementById('favicon').href    = `icons/${BRAND}/icon-192.png`;
    });
  </script>
</head>
<body>
  <!-- Topbar -->
  <header class="topbar">
    <h1>Sistemas Maxi</h1>
    <div style="display:flex; gap:10px; align-items:center;">
      <span id="userBadge" style="font-weight:600;"></span>
      <button onclick="logout()">Sair</button>
    </div>
  </header>

  <!-- Sidebar -->
  <nav class="sidebar">
    <ul>
      <li><a href="dashboard.html">üè† Dashboard</a></li>
      <li><a href="ordem-servico.html">üìù Ordem de Servi√ßo - Manuten√ß√£o Corretiva</a></li>
      <li><a href="calendario.html">üìù Agenda</a></li>
      <li><a href="local.html">üìç Locais / Unidades</a></li>
      <li><a href="tecnico.html">üßë‚Äçüîß T√©cnicos</a></li>
      <li><a href="usuarios.html">üë§ Usu√°rios - Acesso ao Sistema</a></li>
      <li><a href="aparelhos-por-unidade.html">üè• Aparelhos por unidade</a></li>
      <li><a href="pmoc.html">‚úÖ Checklist PMOC - Manuten√ß√£o Preventiva</a></li>
      <li><a href="pmoc-historico.html">üìÇ Hist√≥rico PMOC por Aparelho</a></li>
      <li><a href="pmoc-qrcode.html">üî≥ QR Code PMOC</a></li>
    </ul>
  </nav>

  <!-- Conte√∫do -->
  <main class="main-content">
    <h2>Nova Ordem de Servi√ßo</h2>

    <form id="formOrdemServico" class="form-os" autocomplete="off">
      <section class="section">
        <h3>Identifica√ß√£o</h3>

        <div class="grid-ident">
          <!-- Local (Cliente) -->
          <div>
            <label for="osLocalTxt">Local</label>
            <input id="osLocalTxt" list="dlLocal" placeholder="Digite para buscar..." />
            <datalist id="dlLocal"></datalist>
            <input type="hidden" id="osLocal" value="0" />
          </div>

          <!-- T√©cnico -->
          <div>
            <label for="osTecnicoTxt">T√©cnico Respons√°vel</label>
            <input id="osTecnicoTxt" list="dlTecnicos" placeholder="Digite para buscar..." />
            <datalist id="dlTecnicos"></datalist>
            <input type="hidden" id="osTecnico" value="0" />
          </div>

          <!-- Prioridade -->
          <div class="full-row">
            <label for="prioridade">Prioridade</label>
            <select id="prioridade">
              <option>Baixa</option>
              <option>M√©dia</option>
              <option>Alta</option>
              <option>Urgente</option>
            </select>
          </div>
        </div>
      </section>

      <div class="grid-3" style="margin-top:12px;">
        <div>
          <label for="status">Status</label>
          <select id="status">
            <option>Aberta</option>
            <option>Em Andamento</option>
            <option>Conclu√≠da</option>
          </select>
        </div>
      </div>

      <label for="descricao" style="margin-top:12px;">Descri√ß√£o do Servi√ßo</label>
      <textarea id="descricao" rows="4" placeholder="Descreva o problema/servi√ßo..."></textarea>

      <!-- Localiza√ß√£o (sem mapa) -->
      <section class="section">
        <h3>Localiza√ß√£o do Chamado</h3>
        <div class="grid-3">
          <div>
            <label for="endereco">Endere√ßo</label>
            <input id="endereco" placeholder="Rua, n¬∫, bairro, cidade" />
          </div>
          <div>
            <label for="lat">Latitude</label>
            <input id="lat" placeholder="-23.96..." />
          </div>
          <div>
            <label for="lng">Longitude</label>
            <input id="lng" placeholder="-46.38..." />
          </div>
        </div>

        <div class="geo-row" style="margin-top:10px; display:flex; flex-direction:column; gap:6px;">
          <button
            class="btn-gps btn-gps-full"
            type="button"
            id="btnGeo"
            style="height:46px; font-weight:800;"
          >
            <span class="btn-gps-icon">üìç</span>
            Usar minha localiza√ß√£o
          </button>
          <small class="geo-tip" style="color:#6b7280; text-align:center;">
            Dica: use o bot√£o para preencher LAT/LNG automaticamente.
          </small>
        </div>
      </section>

      <!-- Equipamentos -->
      <section class="section">
        <h3>Rela√ß√£o de Equipamentos</h3>
        <div class="table-wrapper" style="max-width:none;">
          <table class="os-table">
            <thead>
              <tr>
                <th>Patrim√¥nio</th>
                <th>Ambiente/Local</th>
                <th>Marca</th>
                <th>BTUs</th>
                <th>Modelo</th>
                <th>Tipo</th>
                <th>G√°s</th>
                <th style="width:90px;">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="equipBody"></tbody>
          </table>
        </div>
        <button type="button" id="btnAddEquip" class="outline" style="margin-top:8px;">
          + Adicionar equipamento
        </button>
      </section>

      <!-- Pe√ßas / Trocas -->
      <section class="section">
        <h3>Pe√ßas / Trocas</h3>

        <!-- üîπ NOVO BLOCO: sele√ß√£o de pe√ßa + quantidade -->
        <div class="grid-3" style="margin-bottom:8px;">
          <div>
            <label for="pecaId">Pe√ßa utilizada</label>
            <select id="pecaId" name="pecaId">
              <option value="">Carregando pe√ßas...</option>
            </select>
          </div>
          <div>
            <label for="qtdPeca">Quantidade</label>
            <input id="qtdPeca" type="number" min="1" value="1" />
          </div>
        </div>
        <!-- üîπ FIM DO BLOCO NOVO -->

        <div class="table-wrapper" style="max-width:none;">
          <table class="os-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Qtd.</th>
                <th style="width:90px;">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="pecasBody"></tbody>
          </table>
        </div>
        <button type="button" id="btnAddPeca" class="outline" style="margin-top:8px;">
          + Adicionar pe√ßa
        </button>
      </section>

      <!-- Fotos -->
      <section class="section">
        <h3>Fotos</h3>
        <div class="grid-2">
          <div>
            <label for="fotosAntes">Fotos Antes</label>
            <input id="fotosAntes" type="file" accept="image/*" multiple />
            <div id="previewAntes" class="preview-grid"></div>
          </div>
          <div>
            <label for="fotosDepois">Fotos Depois</label>
            <input id="fotosDepois" type="file" accept="image/*" multiple />
            <div id="previewDepois" class="preview-grid"></div>
          </div>
        </div>
      </section>

      <!-- Observa√ß√µes -->
      <section class="section">
        <h3>Observa√ß√µes</h3>
        <textarea id="observacoes" rows="3" placeholder="Informa√ß√µes adicionais..."></textarea>
      </section>

      <button type="submit">Salvar OS</button>
    </form>
  </main>

  <!-- üîπ MODELO ESCONDIDO DA FICHA CORRETIVA (DUAS VIAS) -->
  <div id="printCorretiva" class="pagina-a4" style="display:none;">

    <!-- primeira via -->
    <div class="bloco-corretiva">
      <div class="cabecalho-maxi">
        <img src="img/maxi.png" alt="MAXI">
        <div class="titulo-centro">
          <div><strong>FICHA DE MANUTEN√á√ÉO CORRETIVA DE APARELHOS DE AR CONDICIONADO</strong></div>
          <div>CONTRATO 02/2023</div>
        </div>
        <img src="img/prefeitura-sv.png" alt="Prefeitura de S√£o Vicente">
      </div>

      <div style="margin-top:4mm; font-weight:bold;">Dados do Atendimento:</div>

      <table class="tabela-corretiva">
        <tr>
          <th style="width:18%;">Unidade</th>
          <td id="cor1_unidade"></td>
          <th style="width:10%;">Data</th>
          <td id="cor1_data" style="width:15%;"></td>
        </tr>
        <tr>
          <th>Patrim√¥nio</th>
          <td id="cor1_patrimonio"></td>
          <th>Local</th>
          <td id="cor1_local"></td>
        </tr>
        <tr>
          <th>Marca</th>
          <td id="cor1_marca"></td>
          <th>BTU/h</th>
          <td id="cor1_btu"></td>
        </tr>
        <tr>
          <th>Mod.</th>
          <td id="cor1_modelo"></td>
          <th>Normal/Inv.</th>
          <td id="cor1_tipo"></td>
        </tr>
      </table>

      <div style="margin-top:4mm; font-weight:bold;">Informa√ß√µes da Manuten√ß√£o:</div>
      <div id="cor1_info" class="box-linhas"></div>

      <div class="assinaturas">
        <span>Respons√°vel pela manuten√ß√£o</span>
        <span>Respons√°vel pela unidade de sa√∫de</span>
      </div>
    </div>

    <!-- segunda via (igual √† primeira) -->
    <div class="bloco-corretiva">
      <div class="cabecalho-maxi">
        <img src="img/maxi.png" alt="MAXI">
        <div class="titulo-centro">
          <div><strong>FICHA DE MANUTEN√á√ÉO CORRETIVA DE APARELHOS DE AR CONDICIONADO</strong></div>
          <div>CONTRATO 02/2023</div>
        </div>
        <img src="img/prefeitura-sv.png" alt="Prefeitura de S√£o Vicente">
      </div>

      <div style="margin-top:4mm; font-weight:bold;">Dados do Atendimento:</div>

      <table class="tabela-corretiva">
        <tr>
          <th style="width:18%;">Unidade</th>
          <td id="cor2_unidade"></td>
          <th style="width:10%;">Data</th>
          <td id="cor2_data" style="width:15%;"></td>
        </tr>
        <tr>
          <th>Patrim√¥nio</th>
          <td id="cor2_patrimonio"></td>
          <th>Local</th>
          <td id="cor2_local"></td>
        </tr>
        <tr>
          <th>Marca</th>
          <td id="cor2_marca"></td>
          <th>BTU/h</th>
          <td id="cor2_btu"></td>
        </tr>
        <tr>
          <th>Mod.</th>
          <td id="cor2_modelo"></td>
          <th>Normal/Inv.</th>
          <td id="cor2_tipo"></td>
        </tr>
      </table>

      <div style="margin-top:4mm; font-weight:bold;">Informa√ß√µes da Manuten√ß√£o:</div>
      <div id="cor2_info" class="box-linhas"></div>

      <div class="assinaturas">
        <span>Respons√°vel pela manuten√ß√£o</span>
        <span>Respons√°vel pela unidade de sa√∫de</span>
      </div>
    </div>

  </div>
  <!-- üîπ FIM DO MODELO DA FICHA CORRETIVA -->

  <!-- Bibliotecas de PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- JS principal -->
  <script src="js/script.js"></script>

  <script>
    // Garante login
    requireLogin();

    // Esconde menus se n√£o for Admin (mesma l√≥gica que voc√™ j√° tinha)
    const cargoAtual = sessionStorage.getItem("cargo") || role();
    if (!cargoAtual) {
      window.location.href = "index.html";
    }
    if (cargoAtual !== "Admin") {
      const linkTecnico = document.querySelector('a[href="tecnico.html"]');
      if (linkTecnico) linkTecnico.style.display = "none";

      const linkAbrir = document.querySelector('a[href="abrir-os.html"]');
      if (linkAbrir) linkAbrir.style.display = "none";
    }

    // üîπ NOVA FUN√á√ÉO: carregar lista de pe√ßas do backend
    async function carregarPecas() {
      const select = document.getElementById("pecaId");
      if (!select) return;

      select.innerHTML = '<option value="">Carregando pe√ßas...</option>';

      try {
        // API_BASE j√° deve estar definida em js/script.js
        const resp = await fetch(`${API_BASE}/api/pecas`);

        if (!resp.ok) {
          throw new Error("Erro HTTP: " + resp.status);
        }

        const pecas = await resp.json();

        if (!Array.isArray(pecas) || pecas.length === 0) {
          select.innerHTML = '<option value="">Nenhuma pe√ßa cadastrada</option>';
          return;
        }

        select.innerHTML = '<option value="">Selecione uma pe√ßa...</option>';

        pecas.forEach(p => {
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = `${p.nome} (${p.codigo})`;
          select.appendChild(opt);
        });
      } catch (erro) {
        console.error("Erro ao carregar pe√ßas:", erro);
        select.innerHTML = '<option value="">Erro ao carregar pe√ßas</option>';
      }
    }

    // Chama assim que essa p√°gina carregar
    carregarPecas();
  </script>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator && location.protocol.startsWith('http')) {
      navigator.serviceWorker.register('./service-worker.js', { scope: './' })
        .then(reg => console.log('Service Worker registrado:', reg.scope))
        .catch(err => console.error('Erro ao registrar o Service Worker:', err));
    }
  </script>
</body>
</html>
