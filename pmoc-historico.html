<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hist√≥rico PMOC - AirControl OS</title>

  <!-- CSS principal do app -->
  <link rel="stylesheet" href="css/style.css">

  <!-- PWA b√°sico -->
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#1e90ff" />
  <link rel="apple-touch-icon" href="icons/empresa/icon-192.png" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <!-- Estilos extras s√≥ para os cards do hist√≥rico PMOC -->
  <style>
    /* card de cada registro */
    .card-os {
      background: #fff;
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      font-size: 14px;
    }
    .card-os h3 {
      margin: 0 0 4px 0;
      font-size: 16px;
    }
    .card-os h4 {
      margin: 10px 0 4px 0;
      font-size: 14px;
    }
    .pmoc-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 4px;
    }
    .pmoc-data {
      margin: 0;
      font-size: 13px;
      color: #555;
    }

    /* lista bonitinha dos itens do checklist */
    .lista-itens-pmoc {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    .lista-itens-pmoc li {
      margin-bottom: 6px;
      font-size: 13px;
      line-height: 1.4;
    }
    .pmoc-item-obs {
      color: #444;
      font-style: italic;
      font-size: 12px;
    }

    @media (max-width: 768px) {
      .main-content {
        padding-bottom: 32px;
      }
    }
  </style>
</head>

<body>
  <!-- TOPO -->
  <header class="topbar">
    <button onclick="window.location.href='dashboard.html'" class="btn-voltar">‚Üê</button>
    <h1>Hist√≥rico PMOC</h1>
  </header>

  <!-- MENU LATERAL (opcional ‚Äì se a pessoa n√£o estiver logada, continua funcionando s√≥ como links) -->
  <nav class="sidebar">
    <ul>
      <li><a href="dashboard.html">üè† Dashboard</a></li>
      <li><a href="ordem-servico.html">üìù Ordem de Servi√ßo - Manuten√ß√£o Corretiva</a></li>
      <li><a href="calendario.html">üìÖ Agenda</a></li>
      <li><a href="local.html">üìç Locais / Unidades</a></li>
      <li><a href="tecnico.html">üßë‚Äçüîß T√©cnicos</a></li>
      <li><a href="usuarios.html">üë§ Usu√°rios - Acesso ao Sistema</a></li>
      <li><a href="aparelhos-por-unidade.html">üè• Aparelhos por unidade</a></li>
      <li><a href="pmoc.html">‚úÖ Checklist PMOC - Manuten√ß√£o Preventiva</a></li>
      <li><a href="pmoc-historico.html">üìÇ Hist√≥rico PMOC por Aparelho</a></li>
      <li><a href="pmoc-menu.html">üìå PMOC por cidade / unidade</a></li>
      <li><a href="pmoc-qrcode.html">üî≥ QR Code PMOC</a></li>
    </ul>
  </nav>

  <!-- CONTE√öDO -->
  <main class="main-content">
    <h2>Hist√≥rico de Checklist PMOC</h2>

    <!-- FILTRO -->
    <section class="form-os" style="margin-bottom: 16px;">
      <label for="aparelhoIdInput">ID do aparelho (AparelhoHdvId):</label>
      <input type="number" id="aparelhoIdInput" placeholder="Ex: 2, 3, 10">

      <button type="button" class="tecnico-btn" id="btnBuscar">
        Buscar hist√≥rico
      </button>

      <p id="msgInfo" style="font-size: 13px; color: #555; margin-top: 8px;">
        Dica: voc√™ pode acessar com
        <code>?aparelhoId=10</code> na URL (via QR Code) para carregar automaticamente.
      </p>
    </section>

    <!-- LISTA DE REGISTROS -->
    <section id="listaPmoc"></section>
  </main>

  <!-- Script geral (logout, etc). N√£o tem mais nenhum bloqueio de login aqui dentro. -->
  <script src="js/script.js"></script>

  <!-- L√ìGICA DO HIST√ìRICO PMOC (SEM EXIGIR LOGIN) -->
  <script>
  const API_PMOC_BASE = "https://aircontrolos-api.onrender.com/api/PmocRegistros";

  const inputAparelho = document.getElementById("aparelhoIdInput");
  const btnBuscar = document.getElementById("btnBuscar");
  const listaPmoc = document.getElementById("listaPmoc");
  const msgInfo = document.getElementById("msgInfo");

  btnBuscar.addEventListener("click", () => {
    const id = parseInt(inputAparelho.value, 10);
    if (!id) {
      alert("Informe um ID v√°lido.");
      return;
    }
    carregarHistorico(id);
  });

  inputAparelho.addEventListener("keyup", (e) => {
    if (e.key === "Enter") {
      btnBuscar.click();
    }
  });

  (function initFromQuery() {
    const params = new URLSearchParams(window.location.search);
    const id = params.get("aparelhoId");
    if (id) {
      inputAparelho.value = id;
      carregarHistorico(parseInt(id, 10));
    }
  })();

  async function carregarHistorico(id) {
    listaPmoc.innerHTML = "";
    msgInfo.textContent = `Carregando hist√≥rico do aparelho ${id}...`;

    try {
      const url = `${API_PMOC_BASE}/por-aparelho/${id}`;
      console.log("URL hist√≥rico PMOC:", url);
      
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(resp.status);

      const registros = await resp.json();

      if (!Array.isArray(registros) || !registros.length) {
        msgInfo.textContent = "Nenhum registro encontrado para este aparelho.";
        listaPmoc.innerHTML = "";
        return;
      }

      registros.sort((a, b) => new Date(b.data) - new Date(a.data));

      msgInfo.textContent = `${registros.length} registro(s) encontrado(s).`;
      listaPmoc.innerHTML = "";

      registros.forEach(reg => {
        const card = document.createElement("div");
        card.className = "card-os";

       const dataHora = new Date(reg.data);

      const formatador = new Intl.DateTimeFormat("pt-BR", {
      const dataHora = new Date(reg.data); 

      const formatador = new Intl.DateTimeFormat("pt-BR", {
      timeZone: "America/Sao_Paulo", // <--- ISSO garante que os 3h de diferen√ßa sumam
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit"
     });

       const [dataFormatada, horaFormatada] = formatador.format(dataHora).split(", ");

        const tecnicoNome = reg.tecnicoNome || "";
        const tecnicoEmail = reg.tecnicoEmail || "";
        let linhaTecnico = "";

        if (tecnicoNome) {
          linhaTecnico = `<p><strong>T√©cnico:</strong> ${tecnicoNome}</p>`;
        } else if (tecnicoEmail && tecnicoEmail !== "pmoc@aircontrolos") {
          linhaTecnico = `<p><strong>T√©cnico:</strong> ${tecnicoEmail}</p>`;
        } else {
          linhaTecnico = `<p><strong>T√©cnico:</strong> Desconhecido</p>`;
        }

        let itensHtml = "<p>(itens n√£o dispon√≠veis)</p>";
        const rawItens = reg.checklistJson || reg.itensJson;

        if (rawItens) {
          try {
            const itens = JSON.parse(rawItens);
            if (Array.isArray(itens) && itens.length) {
              itensHtml = '<ul class="lista-itens-pmoc">';
              itens.forEach(item => {
                const status = item.problema ? "üî¥ Problema" : "‚úÖ OK";
                const nomeItem = item.nome || "-";
                const obs = item.observacao || item.observacoes || "";

                itensHtml += `
                  <li>
                    <strong>${nomeItem}</strong> ‚Äì ${status}
                    ${obs ? `<br><span class="pmoc-item-obs">${obs}</span>` : ""}
                  </li>`;
              });
              itensHtml += "</ul>";
            }
          } catch (e) {
            console.warn("Falha ao interpretar itens do checklist:", e);
          }
        }

        card.innerHTML = `
          <div class="pmoc-header">
            <h3>Registro #${reg.id}</h3>
            <p class="pmoc-data"><strong>Data:</strong> ${dataFormatada} ‚Äì ${horaFormatada}</p>
          </div>
          ${linhaTecnico}
          <p><strong>Aparelho ID:</strong> ${reg.aparelhoHdvId}</p>

          <h4>Itens verificados</h4>
          ${itensHtml}

          <h4>Observa√ß√µes t√©cnicas</h4>
          <p>${reg.observacoesTecnicas || "(sem observa√ß√µes)"}</p>
        `;

        listaPmoc.appendChild(card);
      });

      listaPmoc.scrollIntoView({ behavior: "smooth", block: "start" });

    } catch (e) {
      console.error(e);
      msgInfo.textContent = "Erro ao buscar dados.";
      alert("Erro ao comunicar com o servidor.");
    }
  }
</script>

<!-- SERVICE WORKER opcional -->
<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker
      .register("./service-worker.js", { scope: "./" })
      .catch(console.error);
  }
</script>




