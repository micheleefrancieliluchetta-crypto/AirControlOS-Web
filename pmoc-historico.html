<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hist√≥rico PMOC - AirControl OS</title>

  <!-- CSS principal do app -->
  <link rel="stylesheet" href="css/style.css">

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#1e90ff" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
</head>

<body>
  <!-- GUARDA REDIRECT CASO N√ÉO ESTEJA LOGADO -->
  <script>
    (function () {
      const cargo = sessionStorage.getItem("cargo");
      if (!cargo) {
        // guarda a URL completa (caminho + query string, ex: /pmoc-historico.html?aparelhoId=10)
        const redirectUrl = window.location.pathname + window.location.search;
        sessionStorage.setItem("redirectAfterLogin", redirectUrl);

        alert("Fa√ßa login para acessar o hist√≥rico PMOC.");
        window.location.href = "index.html";
      }
      // se tiver cargo mas n√£o for admin, vamos bloquear mais embaixo
    })();
  </script>

  <!-- TOPO COM VOLTAR -->
  <header class="topbar">
    <button onclick="window.location.href='dashboard.html'" class="btn-voltar">‚Üê</button>
    <h1>Hist√≥rico PMOC</h1>
    <button onclick="logout()">Sair</button>
  </header>

  <!-- MENU LATERAL -->
  <nav class="sidebar">
    <ul>
      <li><a href="dashboard.html">üè† Dashboard</a></li>
      <li><a href="ordem-servico.html">üìù Ordem de Servi√ßo - Manuten√ß√£o Corretiva</a></li>
      <li><a href="calendario.html">üìÖ Agenda</a></li>
      <li><a href="local.html">üìç Locais / Unidades</a></li>
      <li><a href="tecnico.html">üßë‚Äçüîß T√©cnicos</a></li>
      <li><a href="usuarios.html">üë§ Usu√°rios - Acesso ao Sistema</a></li>
      <li><a href="aparelhos-por-unidade.html">üè• Aparelhos por unidade</a></li>
      <li><a href="pmoc.html">‚úÖ Checklist PMOC - Manuten√ß√£o Preventiva</a></li>
      <li><a href="pmoc-historico.html">üìÇ Hist√≥rico PMOC por Aparelho</a></li>
      <li><a href="pmoc-menu.html">üìå PMOC por cidade / unidade</a></li>
      <li><a href="pmoc-qrcode.html">üî≥ QR Code PMOC</a></li>
    </ul>
  </nav>

  <!-- CONTE√öDO -->
  <main class="main-content">
    <h2>Hist√≥rico de Checklist PMOC</h2>

    <!-- FILTRO -->
    <section class="form-os" style="margin-bottom: 16px;">
      <label for="aparelhoIdInput">ID do aparelho (AparelhoHdvId):</label>
      <input type="number" id="aparelhoIdInput" placeholder="Ex: 10">

      <button type="button" class="tecnico-btn" id="btnBuscar">
        Buscar hist√≥rico
      </button>

      <p id="msgInfo" style="font-size: 13px; color: #555; margin-top: 8px;">
        Dica: voc√™ pode acessar com
        <code>?aparelhoId=10</code> na URL para carregar automaticamente.
      </p>
    </section>

    <!-- LISTA DE REGISTROS -->
    <section id="listaPmoc"></section>
  </main>

  <!-- SCRIPT PRINCIPAL (o mesmo do resto do app) -->
  <script src="js/script.js"></script>

  <!-- PERMISS√ÉO ADMIN (VERS√ÉO COM REDIRECT J√Å RESOLVIDO ACIMA) -->
  <script>
    (function () {
      const cargo = sessionStorage.getItem("cargo");
      if (!cargo) {
        // se chegou aqui sem cargo √© porque o primeiro script ainda n√£o rodou ou o usu√°rio limpou storage
        const redirectUrl = window.location.pathname + window.location.search;
        sessionStorage.setItem("redirectAfterLogin", redirectUrl);
        alert("Fa√ßa login para continuar.");
        window.location.href = "index.html";
        return;
      }

      if (cargo.toLowerCase() !== "admin") {
        alert("Somente administradores podem acessar esta p√°gina.");
        window.location.href = "dashboard.html";
      }
    })();
  </script>

  <!-- L√ìGICA DE HIST√ìRICO PMOC -->
  <script>
    const API_PMOC_BASE = "https://aircontrolos-api.onrender.com/api/PmocRegistros";

    const inputAparelho = document.getElementById("aparelhoIdInput");
    const btnBuscar = document.getElementById("btnBuscar");
    const listaPmoc = document.getElementById("listaPmoc");
    const msgInfo = document.getElementById("msgInfo");

    // Clique no bot√£o "Buscar hist√≥rico"
    btnBuscar.addEventListener("click", () => {
      const id = parseInt(inputAparelho.value, 10);
      if (!id) {
        alert("Informe um ID v√°lido.");
        return;
      }
      carregarHistorico(id);
    });

    // Se vier ?aparelhoId=10 na URL, j√° carrega autom√°tico
    (function init() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get("aparelhoId");
      if (id) {
        inputAparelho.value = id;
        carregarHistorico(id);
      }
    })();

    async function carregarHistorico(id) {
  listaPmoc.innerHTML = "";
  msgInfo.textContent = `Carregando hist√≥rico do aparelho ${id}...`;

  try {
    const resp = await fetch(`${API_PMOC_BASE}/por-aparelho/${id}`);
    if (!resp.ok) {
      throw new Error(resp.status);
    }

    const registros = await resp.json();

    if (!registros.length) {
      msgInfo.textContent = "Nenhum registro encontrado para este aparelho.";
      return;
    }

    msgInfo.textContent = `${registros.length} registro(s) encontrado(s).`;

    registros.forEach(reg => {
      const card = document.createElement("div");
      card.className = "card-os";

      const data = reg.data
        ? new Date(reg.data).toLocaleString("pt-BR")
        : "(sem data)";

      // pega t√©cnico (nome se tiver, sen√£o email)
      const tecnico = reg.tecnicoNome || reg.tecnicoEmail || "-";

      // monta lista bonitinha dos itens
      let itensHtml = "<p>(itens n√£o dispon√≠veis)</p>";
      const rawItens = reg.checklistJson || reg.itensJson;
      if (rawItens) {
        try {
          const itens = JSON.parse(rawItens);
          if (Array.isArray(itens) && itens.length) {
            itensHtml = '<ul class="lista-itens-pmoc">';
            itens.forEach(item => {
              const status = item.problema ? "üî¥ Problema" : "‚úÖ OK";
              const obs = item.observacao || item.observacoes || "";
              itensHtml += `
                <li>
                  <strong>${item.nome || "-"}</strong> ‚Äì ${status}
                  ${obs ? `<br><span class="pmoc-item-obs">${obs}</span>` : ""}
                </li>`;
            });
            itensHtml += "</ul>";
          }
        } catch (e) {
          console.warn("Falha ao interpretar itensJson/checklistJson:", e);
        }
      }

      card.innerHTML = `
        <h3>Registro #${reg.id}</h3>
        <p><strong>Data:</strong> ${data}</p>
        <p><strong>T√©cnico:</strong> ${tecnico}</p>
        <p><strong>Aparelho ID:</strong> ${reg.aparelhoHdvId}</p>
        <hr>
        <h4>Itens</h4>
        ${itensHtml}
        <h4>Observa√ß√µes t√©cnicas</h4>
        <p>${reg.observacoesTecnicas || "(sem observa√ß√µes)"}</p>
      `;

      listaPmoc.appendChild(card);
    });

  } catch (e) {
    console.error(e);
    msgInfo.textContent = "Erro ao buscar dados.";
    alert("Erro ao comunicar com o servidor.");
  }
}

  <!-- SERVICE WORKER -->
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker
        .register("./service-worker.js", { scope: "./" })
        .catch(console.error);
    }
  </script>
</body>
</html>
