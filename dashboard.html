<!-- dashboard.html -->
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard - AirControl OS</title>

  <link rel="stylesheet" href="css/style.css" />

  <!-- Leaflet para o mapa do modal -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- jsPDF para gera√ß√£o de PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- BRAND TOGGLE -->
  <link id="app-manifest" rel="manifest" href="manifest.webmanifest" />
  <link id="apple-icon" rel="apple-touch-icon" href="icons/empresa/icon-192.png" />
  <link id="favicon" rel="icon" href="icons/empresa/icon-192.png" />
  <meta name="theme-color" content="#1e90ff" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <script>
    const BRAND = localStorage.getItem('brand') || 'empresa';
    document.getElementById('apple-icon').href = `icons/${BRAND}/icon-192.png`;
    document.getElementById('favicon').href    = `icons/${BRAND}/icon-192.png`;
  </script>
</head>
<body>
  <!-- Topbar -->
  <header class="topbar">
    <h1>AirControl OS</h1>
    <div style="display:flex; gap:10px; align-items:center;">
      <span id="userBadge" style="font-weight:600;"></span>
      <button onclick="logout()">Sair</button>
    </div>
  </header>

  <!-- Sidebar -->
  <nav class="sidebar">
     <ul>
      <li><a href="dashboard.html">üè† Dashboard</a></li>
      <li><a href="ordem-servico.html">üìù Ordem de Servi√ßo - Manuten√ß√£o Corretiva</a></li>
      <li><a href="calendario.html">üìù Agenda</a></li>
      <li><a href="local.html">üìç Locais / Unidades</a></li>
      <li><a href="tecnico.html">üßë‚Äçüîß T√©cnicos</a></li>
      <li><a href="usuarios.html">üë§ Usu√°rios - Acesso ao Sistema</a></li>
      <li><a href="aparelhos-por-unidade.html">üè• Aparelhos por unidade</a></li>
      <li><a href="pmoc.html">‚úÖ Checklist PMOC - Manuten√ß√£o Preventiva</a></li>
      <li><a href="pmoc-historico.html">üìÇ Hist√≥rico PMOC por Aparelho</a></li>
      <li><a href="pmoc-menu.html">PMOC por cidade / unidade</a></li>
    </ul>
  </nav>

  <!-- Conte√∫do -->
  <main class="main-content">
    <h2>Resumo de Ordens de Servi√ßo</h2>

    <div class="cards">
      <div class="card card-blue">
        <h3>üìÇ Abertas</h3>
        <p id="osAbertas">0</p>
      </div>
      <div class="card card-orange">
        <h3>üîß Em Andamento</h3>
        <p id="osAndamento">0</p>
      </div>
      <div class="card card-green">
        <h3>‚úÖ Conclu√≠das</h3>
        <p id="osConcluidas">0</p>
      </div>
    </div>

    <section class="os-toolbar">
      <div class="filters">
        <button class="chip active" data-filter="Todas">Todas</button>
        <button class="chip" data-filter="Aberta">Abertas</button>
        <button class="chip" data-filter="Em Andamento">Em Andamento</button>
        <button class="chip" data-filter="Conclu√≠da">Conclu√≠das</button>
      </div>

      <div class="tools">
        <input id="buscaOS" class="search" placeholder="Buscar OS ou Local..." />
        <a class="btn-primary" href="ordem-servico.html">+ Nova OS</a>
      </div>
    </section>

    <div class="table-wrapper">
      <table class="os-table" id="tabelaOS">
        <thead>
          <tr>
            <th>OS</th>
            <th>Local</th>
            <th>T√©cnico</th>
            <th>Prioridade</th>
            <th>Status</th>
            <th>Criada em</th>
            <th>Conclu√≠da em</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tbodyOS"></tbody>
      </table>
      <p id="msgVazia" class="muted" style="display:none;">
        Nenhuma ordem encontrada para este filtro.
      </p>
    </div>
  </main>

  <!-- Modal de Detalhes -->
  <div id="modalOS" class="modal" style="display:none;">
    <div class="modal-body">
      <div class="modal-header">
        <h3>Detalhes da OS</h3>
        <button class="close" onclick="fecharModal()" aria-label="Fechar">√ó</button>
      </div>

      <div class="modal-content">
        <div class="modal-grid">
          <div>
            <h4>Dados</h4>
            <p><strong>Local:</strong> <span id="detLocal">-</span></p>
            <p><strong>T√©cnico:</strong> <span id="detTecnico">-</span></p>
            <p><strong>Prioridade:</strong> <span id="detPrioridade">-</span></p>
            <p>
              <strong>Status:</strong>
              <select
                id="detStatus"
                class="status-select"
                style="display:inline-block; width:auto;"
              ></select>
              <button class="outline" type="button" onclick="salvarStatusModal()">
                Salvar
              </button>
            </p>
            <p><strong>Criada em:</strong> <span id="detCriadaEm">-</span></p>
            <p><strong>Conclu√≠da em:</strong> <span id="detConcluidaEm">-</span></p>
          </div>

          <div>
            <h4>M√°quina</h4>
            <p><strong>Tipo:</strong> <span id="detTipo">-</span></p>
            <p><strong>BTUs:</strong> <span id="detBtus">-</span></p>
            <p><strong>Marca:</strong> <span id="detMarca">-</span></p>
            <p><strong>Modelo:</strong> <span id="detModelo">-</span></p>
            <p><strong>N¬∫ S√©rie:</strong> <span id="detSerie">-</span></p>
          </div>
        </div>

        <h4>Local</h4>
        <p><strong>Endere√ßo:</strong> <span id="detEndereco">-</span></p>
        <div id="detMap" class="map" style="height:260px;"></div>

        <h4 style="margin-top:14px;">Descri√ß√£o</h4>
        <p id="detDescricao">-</p>

        <h4 style="margin-top:14px;">Pe√ßas / Trocas</h4>
        <table class="tabela-pecas" id="detTabelaPecas">
          <thead>
            <tr><th>Item</th><th>Qtd.</th></tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="modal-photos">
          <div>
            <h4>Fotos Antes</h4>
            <div id="detFotosAntes" class="preview-grid"></div>
          </div>
          <div>
            <h4>Fotos Depois</h4>
            <div id="detFotosDepois" class="preview-grid"></div>
          </div>
        </div>

        <!-- Bot√£o para gerar PDF da OS -->
        <div style="margin-top:18px; text-align:right;">
          <button type="button" class="btn-primary" onclick="gerarPdfOrdem()">
            üìÑ Gerar PDF da OS
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS principal -->
  <script src="js/script.js"></script>

  <!-- Controle de login e permiss√£o -->
<script>
  // Garante que o usu√°rio esteja logado (usa fun√ß√£o do script.js)
  requireLogin();

  // L√™ o cargo salvo e padroniza
  const cargoBruto = sessionStorage.getItem("cargo") || role() || "";
  const cargo = cargoBruto.toString().trim().toLowerCase();

  // Considera admin qualquer cargo que comece com "admin"
  const ehAdmin = cargo.startsWith("admin");

  // Esconde menus exclusivos de admin
  if (!ehAdmin) {
    const linkTecnico = document.querySelector('a[href="tecnico.html"]');
    if (linkTecnico) linkTecnico.style.display = "none";

    const linkAbrir = document.querySelector('a[href="abrir-os.html"]');
    if (linkAbrir) linkAbrir.style.display = "none";
  }
</script>

  <!-- Registro do Service Worker -->
  <script>
    if ("serviceWorker" in navigator && location.protocol.startsWith("http")) {
      navigator.serviceWorker
        .register("./service-worker.js", { scope: "./" })
        .then((reg) => console.log("Service Worker registrado:", reg.scope))
        .catch((err) => console.error("Erro ao registrar o Service Worker:", err));
    }
  </script>
</body>
</html>
