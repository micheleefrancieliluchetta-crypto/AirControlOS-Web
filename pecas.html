<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pe√ßas - Sistemas Maxi</title>

  <link rel="stylesheet" href="css/style.css" />

  <!-- BRAND TOGGLE -->
  <link id="app-manifest" rel="manifest" href="manifest.webmanifest" />
  <link id="apple-icon" rel="apple-touch-icon" href="icons/empresa/icon-192.png" />
  <link id="favicon" rel="icon" href="icons/empresa/icon-192.png" />
  <meta name="theme-color" content="#1e90ff" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <script>
    const BRAND = localStorage.getItem('brand') || 'empresa';
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('apple-icon').href = `icons/${BRAND}/icon-192.png`;
      document.getElementById('favicon').href    = `icons/${BRAND}/icon-192.png`;
    });
  </script>
</head>
<body>
  <!-- Topbar -->
  <header class="topbar">
    <h1>Sistemas Maxi</h1>
    <div style="display:flex; gap:10px; align-items:center;">
      <span id="userBadge" style="font-weight:600;"></span>
      <button onclick="logout()">Sair</button>
    </div>
  </header>

  <!-- Sidebar -->
  <nav class="sidebar">
    <ul>
      <li><a href="dashboard.html">üè† Dashboard</a></li>
      <li><a href="ordem-servico.html">üìù Ordem de Servi√ßo - Manuten√ß√£o Corretiva</a></li>
      <li><a href="calendario.html">üìù Agenda</a></li>
      <li><a href="local.html">üìç Locais / Unidades</a></li>
      <li><a href="tecnico.html">üßë‚Äçüîß T√©cnicos</a></li>
      <li><a href="usuarios.html">üë§ Usu√°rios - Acesso ao Sistema</a></li>
      <li><a href="aparelhos-por-unidade.html">üè• Aparelhos por unidade</a></li>
      <li><a href="pecas.html" class="active">üõ†Ô∏è Pe√ßas / Cat√°logo</a></li>
      <li><a href="pmoc.html">‚úÖ Checklist PMOC - Manuten√ß√£o Preventiva</a></li>
      <li><a href="pmoc-historico.html">üìÇ Hist√≥rico PMOC por Aparelho</a></li>
      <li><a href="pmoc-qrcode.html">üî≥ QR Code PMOC</a></li>
    </ul>
  </nav>

  <!-- Conte√∫do -->
  <main class="main-content">
    <h2>Cat√°logo de Pe√ßas</h2>

    <!-- Formul√°rio de nova pe√ßa -->
    <section class="section">
      <h3>Cadastrar nova pe√ßa</h3>
      <form id="formPeca" class="form-os" autocomplete="off">
        <div class="grid-3">
          <div>
            <label for="pecaNome">Nome da pe√ßa *</label>
            <input id="pecaNome" required placeholder="Ex.: Compressor 24.000 BTU" />
          </div>
          <div>
            <label for="pecaCodigo">C√≥digo (opcional)</label>
            <input id="pecaCodigo" placeholder="Ex.: CMP-24000" />
          </div>
          <div>
            <label for="pecaObs">Observa√ß√£o (opcional)</label>
            <input id="pecaObs" placeholder="Marca, modelo, voltagem..." />
          </div>
        </div>
        <button type="submit" style="margin-top:10px;">Salvar pe√ßa</button>
      </form>
    </section>

    <!-- Lista de pe√ßas -->
    <section class="section">
      <h3>Pe√ßas cadastradas</h3>
      <div class="table-wrapper" style="max-width:none;">
        <table class="os-table">
          <thead>
            <tr>
              <th>Nome</th>
              <th>C√≥digo</th>
              <th>Observa√ß√£o</th>
              <th style="width:90px;">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tbodyPecas">
            <tr>
              <td colspan="4">Carregando pe√ßas...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- JS principal (define API_BASE, requireLogin, role, logout, etc.) -->
  <script src="js/script.js"></script>

  <!-- Se por algum motivo API_BASE n√£o vier do script.js, definimos um padr√£o -->
  <script>
    window.API_BASE = window.API_BASE || "https://aircontrolos-api.onrender.com";
  </script>

  <script>
    // ========= CONTROLE DE LOGIN / PERMISS√ïES =========
    requireLogin();

    const cargoAtual = sessionStorage.getItem("cargo") || role();
    if (!cargoAtual) {
      window.location.href = "index.html";
    }

    // Esconde menus se n√£o for Admin
    if (cargoAtual !== "Admin") {
      const linkTecnico = document.querySelector('a[href="tecnico.html"]');
      if (linkTecnico) linkTecnico.style.display = "none";

      const linkUsuarios = document.querySelector('a[href="usuarios.html"]');
      if (linkUsuarios) linkUsuarios.style.display = "none";
    }

    // ========= ELEMENTOS =========
    const tbodyPecas = document.getElementById("tbodyPecas");
    const formPeca   = document.getElementById("formPeca");

    // ========= CARREGAR PE√áAS =========
    async function carregarPecasCatalogo() {
      tbodyPecas.innerHTML = `
        <tr><td colspan="4">Carregando pe√ßas...</td></tr>
      `;

      try {
        const token = localStorage.getItem("token") || "";
        const resp = await fetch(`${API_BASE}/api/pecas`, {
          method: "GET",
          headers: {
            "Authorization": token ? `Bearer ${token}` : ""
          }
        });

        if (!resp.ok) {
          const txt = await resp.text();
          console.error("Erro HTTP ao carregar pe√ßas:", resp.status, txt);
          tbodyPecas.innerHTML = `
            <tr><td colspan="4">Erro ao carregar pe√ßas (HTTP ${resp.status}).</td></tr>
          `;
          return;
        }

        const pecas = await resp.json();

        if (!Array.isArray(pecas) || pecas.length === 0) {
          tbodyPecas.innerHTML = `
            <tr><td colspan="4">Nenhuma pe√ßa cadastrada.</td></tr>
          `;
          return;
        }

        tbodyPecas.innerHTML = "";
        pecas.forEach(p => {
          const tr = document.createElement("tr");
          const codigo = p.codigo || "";
          const obs    = p.observacao || p.descricao || "";

          tr.innerHTML = `
            <td>${p.nome}</td>
            <td>${codigo}</td>
            <td>${obs}</td>
            <td>
              <button type="button" data-id="${p.id}" style="padding:4px 8px;">
                Excluir
              </button>
            </td>
          `;
          tbodyPecas.appendChild(tr);
        });
      } catch (erro) {
        console.error("Erro ao carregar pe√ßas:", erro);
        tbodyPecas.innerHTML = `
          <tr><td colspan="4">Erro ao carregar pe√ßas. Ver console.</td></tr>
        `;
      }
    }

    // ========= SALVAR NOVA PE√áA =========
    formPeca.addEventListener("submit", async (e) => {
      e.preventDefault();

      const nome  = document.getElementById("pecaNome").value.trim();
      const codigo = document.getElementById("pecaCodigo").value.trim();
      const obs    = document.getElementById("pecaObs").value.trim();

      if (!nome) {
        alert("Informe o nome da pe√ßa.");
        return;
      }

      try {
        const token = localStorage.getItem("token") || "";
        const resp = await fetch(`${API_BASE}/api/pecas`, {
          method: "POST",
          mode: "cors",
          headers: {
            "Content-Type": "application/json",
            "Authorization": token ? `Bearer ${token}` : ""
          },
          body: JSON.stringify({
            nome: nome,
            codigo: codigo,
            observacao: obs
          })
        });

        if (!resp.ok) {
          const txt = await resp.text();
          console.error("Erro ao salvar pe√ßa (HTTP):", resp.status, txt);
          alert("Erro ao salvar pe√ßa. Veja o console do navegador.");
          return;
        }

        formPeca.reset();
        carregarPecasCatalogo();
      } catch (erro) {
        console.error("Erro ao salvar pe√ßa (fetch falhou):", erro);
        alert("Erro ao salvar pe√ßa (falha de conex√£o / CORS).");
      }
    });

    // ========= EXCLUS√ÉO DE PE√áA =========
    tbodyPecas.addEventListener("click", async (ev) => {
      const btn = ev.target.closest("button[data-id]");
      if (!btn) return;

      const id = btn.dataset.id;
      if (!id) return;

      if (!confirm("Deseja realmente excluir esta pe√ßa do cat√°logo?")) return;

      try {
        const token = localStorage.getItem("token") || "";
        const resp = await fetch(`${API_BASE}/api/pecas/${id}`, {
          method: "DELETE",
          headers: {
            "Authorization": token ? `Bearer ${token}` : ""
          }
        });

        if (!resp.ok) {
          const txt = await resp.text();
          console.error("Erro ao excluir pe√ßa:", resp.status, txt);
          alert("Erro ao excluir pe√ßa.");
          return;
        }

        carregarPecasCatalogo();
      } catch (erro) {
        console.error("Erro ao excluir pe√ßa:", erro);
        alert("Erro ao excluir pe√ßa (falha de conex√£o / CORS).");
      }
    });

    // ========= CARREGAR AO ABRIR TELA =========
    carregarPecasCatalogo();
  </script>

  <!-- Service Worker -->
  <script>
    if ("serviceWorker" in navigator && location.protocol.startsWith("http")) {
      navigator.serviceWorker
        .register("./service-worker.js", { scope: "./" })
        .then((reg) => console.log("Service Worker registrado:", reg.scope))
        .catch((err) => console.error("Erro ao registrar o Service Worker:", err));
    }
  </script>
</body>
</html>


